(window["matrixElement_jsonp"]=window["matrixElement_jsonp"]||[]).push([[16],{"0877":function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return L}));r("d9e2"),r("14d9"),r("2c66"),r("249d"),r("40e9"),r("907a"),r("986a"),r("1d02"),r("3c5d"),r("6ce5"),r("2834"),r("4ea1"),r("88e6"),r("70cc"),r("eb03"),r("22e5"),r("c01e"),r("fa76"),r("8306");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("3261"),c=r.n(a),u=r("700b"),d=r("b2e0"),l=r("03f5"),g=r("e44f"),y=r("0036"),h=r("be2e"),p=r("1fa7"),v=r("9eee"),f=r("1d66"),m=r("67b8"),b=r("4076"),k=r("6f26"),S=r("420b"),R=r("e3ab"),w=r("e98d"),I=r("597c"),K=r("f754"),C=r("bf66"),M=r("ee85"),E=r("de1c"),O=r("0fc9"),_=r("16b9"),D=r("8d85"),B=r("d0d0"),q=r("2ec6"),P=r("ac66"),U=r("c2ab"),T=r("2f97"),V=r("eb1f"),N=r("6c93");function A(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function j(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?A(Object(r),!0).forEach((function(t){s()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):A(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var x=[N["a"].Sas,N["a"].ScanQrCode,N["a"].ShowQrCode,N["a"].Reciprocate];class L extends O["b"]{constructor(e,t,r,i,n,o,a){super(),this.logger=e,this.olmMachine=t,this.http=r,this.userId=i,this.secretStorage=o,this.cryptoCallbacks=a,s()(this,"_trustCrossSignedDevices",!0),s()(this,"stopped",!1),s()(this,"roomEncryptors",{}),s()(this,"eventDecryptor",void 0),s()(this,"keyClaimManager",void 0),s()(this,"outgoingRequestProcessor",void 0),s()(this,"crossSigningIdentity",void 0),s()(this,"backupManager",void 0),s()(this,"outgoingRequestsManager",void 0),s()(this,"perSessionBackupDownloader",void 0),s()(this,"dehydratedDeviceManager",void 0),s()(this,"reemitter",new D["b"](this)),s()(this,"globalBlacklistUnverifiedDevices",!1),s()(this,"_supportedVerificationMethods",x),this.outgoingRequestProcessor=new v["a"](t,r),this.outgoingRequestsManager=new U["a"](this.logger,t,this.outgoingRequestProcessor),this.keyClaimManager=new f["a"](t,this.outgoingRequestProcessor),this.backupManager=new _["a"](t,r,this.outgoingRequestProcessor),this.perSessionBackupDownloader=new T["a"](this.logger,this.olmMachine,this.http,this.backupManager),this.dehydratedDeviceManager=new V["a"](this.logger,t,r,this.outgoingRequestProcessor,o),this.eventDecryptor=new F(this.logger,t,this.perSessionBackupDownloader),this.reemitter.reEmit(this.backupManager,[E["b"].KeyBackupStatus,E["b"].KeyBackupSessionsRemaining,E["b"].KeyBackupFailed,E["b"].KeyBackupDecryptionKeyCached]),this.crossSigningIdentity=new R["a"](t,this.outgoingRequestProcessor,o),this.checkKeyBackupAndEnable()}getOlmMachineOrThrow(){if(this.stopped)throw new q["a"];return this.olmMachine}set globalErrorOnUnknownDevices(e){}get globalErrorOnUnknownDevices(){return!1}stop(){this.stopped||(this.stopped=!0,this.keyClaimManager.stop(),this.backupManager.stop(),this.outgoingRequestsManager.stop(),this.perSessionBackupDownloader.stop(),this.dehydratedDeviceManager.stop(),this.olmMachine.close())}encryptEvent(e,t){var r=this;return n()((function*(){var t=e.getRoomId(),i=r.roomEncryptors[t];if(!i)throw new Error("Cannot encrypt event in unconfigured room ".concat(t));yield i.encryptEvent(e,r.globalBlacklistUnverifiedDevices)}))()}decryptEvent(e){var t=this;return n()((function*(){var r=e.getRoomId();if(!r)throw new Error("to-device event was not decrypted in preprocessToDeviceMessages");return yield t.eventDecryptor.attemptEventDecryption(e)}))()}getEventEncryptionInfo(e){var t,r={};return r.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,r.algorithm=e.getWireContent().algorithm,r.senderKey&&r.algorithm?(r.encrypted=!0,r.authenticated=!0,r.mismatchedSender=!0,r):(r.encrypted=!1,r)}checkUserTrust(e){return new b["UserVerificationStatus"](!1,!1,!1)}getStoredCrossSigningForUser(e){return null}checkOwnCrossSigningTrust(){return n()((function*(){}))()}getBackupDecryptor(e,t){var r=this;return n()((function*(){if("m.megolm_backup.v1.curve25519-aes-sha2"!=e.algorithm)throw new Error("getBackupDecryptor Unsupported algorithm ".concat(e.algorithm));var i=e.auth_data;if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");var n=u["BackupDecryptionKey"].fromBase64(Object(P["b"])(t));if(i.public_key!=n.megolmV1PublicKey.publicKeyBase64)throw new Error("getBackupDecryptor key mismatch error");return r.backupManager.createBackupDecryptor(n)}))()}importBackedUpRoomKeys(e,t,r){var i=this;return n()((function*(){return yield i.backupManager.importBackedUpRoomKeys(e,t,r)}))()}getVersion(){var e=u["getVersions"]();return"Rust SDK ".concat(e.matrix_sdk_crypto," (").concat(e.git_sha,"), Vodozemac ").concat(e.vodozemac)}isEncryptionEnabledInRoom(e){var t=this;return n()((function*(){var r=yield t.olmMachine.getRoomSettings(new u["RoomId"](e));return Boolean(null===r||void 0===r?void 0:r.algorithm)}))()}getOwnDeviceKeys(){var e=this;return n()((function*(){var t=e.olmMachine.identityKeys;return{ed25519:t.ed25519.toBase64(),curve25519:t.curve25519.toBase64()}}))()}prepareToEncrypt(e){var t=this.roomEncryptors[e.roomId];t&&t.prepareForEncryption(this.globalBlacklistUnverifiedDevices)}forceDiscardSession(e){var t;return null===(t=this.roomEncryptors[e])||void 0===t?void 0:t.forceDiscardSession()}exportRoomKeys(){var e=this;return n()((function*(){var t=yield e.olmMachine.exportRoomKeys(()=>!0);return JSON.parse(t)}))()}exportRoomKeysAsJson(){var e=this;return n()((function*(){return yield e.olmMachine.exportRoomKeys(()=>!0)}))()}importRoomKeys(e,t){var r=this;return n()((function*(){return yield r.backupManager.importRoomKeys(e,t)}))()}importRoomKeysAsJson(e,t){var r=this;return n()((function*(){return yield r.backupManager.importRoomKeysAsJson(e,t)}))()}userHasCrossSigningKeys(){var e=arguments,t=this;return n()((function*(){var r,i=e.length>0&&void 0!==e[0]?e[0]:t.userId,n=e.length>1&&void 0!==e[1]&&e[1],o=yield t.olmMachine.trackedUsers();for(var s of o)if(i===s.toString()){r=s;break}if(void 0!==r){if(i===t.userId){var a=t.olmMachine.queryKeysForUsers([r.clone()]);yield t.outgoingRequestProcessor.makeOutgoingRequest(a)}var c=yield t.olmMachine.getIdentity(r);return null===c||void 0===c||c.free(),void 0!==c}if(n){var u,d=yield t.downloadDeviceList(new Set([i])),l=null===(u=d.master_keys)||void 0===u?void 0:u[i];return!!l&&Boolean(Object.values(l.keys)[0])}return!1}))()}getUserDeviceInfo(e){var t=arguments,r=this;return n()((function*(){var i=t.length>1&&void 0!==t[1]&&t[1],n=new Map,o=yield r.getOlmMachineOrThrow().trackedUsers(),s=new Set;o.forEach(e=>s.add(e.toString()));var a=new Set;for(var c of e)s.has(c)?n.set(c,yield r.getUserDevices(c)):a.add(c);if(i&&a.size>=1){var u=yield r.downloadDeviceList(a);Object.entries(u.device_keys).forEach(e=>{var[t,r]=e;return n.set(t,Object(k["a"])(r))})}return n}))()}getUserDevices(e){var t=this;return n()((function*(){var r=new u["UserId"](e),i=yield t.olmMachine.getUserDevices(r,1);try{var n=i.devices();try{return new Map(n.map(e=>[e.deviceId.toString(),Object(k["b"])(e,r)]))}finally{n.forEach(e=>e.free())}}finally{i.free()}}))()}downloadDeviceList(e){var t=this;return n()((function*(){var r={device_keys:{}};return e.forEach(e=>r.device_keys[e]=[]),yield t.http.authedRequest(h["i"].Post,"/_matrix/client/v3/keys/query",void 0,r,{prefix:""})}))()}getTrustCrossSignedDevices(){return this._trustCrossSignedDevices}setTrustCrossSignedDevices(e){this._trustCrossSignedDevices=e}setDeviceVerified(e,t){var r=arguments,i=this;return n()((function*(){var n=!(r.length>2&&void 0!==r[2])||r[2],o=yield i.olmMachine.getDevice(new u["UserId"](e),new u["DeviceId"](t));if(!o)throw new Error("Unknown device ".concat(e,"|").concat(t));try{yield o.setLocalTrust(n?u["LocalTrust"].Verified:u["LocalTrust"].Unset)}finally{o.free()}}))()}crossSignDevice(e){var t=this;return n()((function*(){var r=yield t.olmMachine.getDevice(new u["UserId"](t.userId),new u["DeviceId"](e));if(!r)throw new Error("Unknown device ".concat(e));try{var i=yield r.verify();yield t.outgoingRequestProcessor.makeOutgoingRequest(i)}finally{r.free()}}))()}getDeviceVerificationStatus(e,t){var r=this;return n()((function*(){var i=yield r.olmMachine.getDevice(new u["UserId"](e),new u["DeviceId"](t));if(!i)return null;try{return new b["DeviceVerificationStatus"]({signedByOwner:i.isCrossSignedByOwner(),crossSigningVerified:i.isCrossSigningTrusted(),localVerified:i.isLocallyTrusted(),trustCrossSignedDevices:r._trustCrossSignedDevices})}finally{i.free()}}))()}getUserVerificationStatus(e){var t=this;return n()((function*(){var r=yield t.getOlmMachineOrThrow().getIdentity(new u["UserId"](e));if(void 0===r)return new b["UserVerificationStatus"](!1,!1,!1);var i=r.isVerified();return r.free(),new b["UserVerificationStatus"](i,!1,!1)}))()}isCrossSigningReady(){var e=this;return n()((function*(){var{privateKeysInSecretStorage:t,privateKeysCachedLocally:r}=yield e.getCrossSigningStatus(),i=Boolean(r.masterKey)&&Boolean(r.selfSigningKey)&&Boolean(r.userSigningKey),n=yield e.getOwnIdentity();return!(null===n||void 0===n||!n.isVerified())&&(i||t)}))()}getCrossSigningKeyId(){var e=arguments,t=this;return n()((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:b["CrossSigningKey"].Master,i=yield t.olmMachine.getIdentity(new u["UserId"](t.userId));if(!i)return null;try{var n,o=yield t.olmMachine.crossSigningStatus(),s=o.hasMaster&&o.hasUserSigning&&o.hasSelfSigning;if(!s)return null;if(!i.isVerified())return null;switch(r){case b["CrossSigningKey"].Master:n=i.masterKey;break;case b["CrossSigningKey"].SelfSigning:n=i.selfSigningKey;break;case b["CrossSigningKey"].UserSigning:n=i.userSigningKey;break;default:return null}var a=JSON.parse(n);return Object.values(a.keys)[0]}finally{i.free()}}))()}bootstrapCrossSigning(e){var t=this;return n()((function*(){yield t.crossSigningIdentity.bootstrapCrossSigning(e)}))()}isSecretStorageReady(){var e=this;return n()((function*(){var t=["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"],r=null!=(yield e.backupManager.getActiveBackupVersion());return r&&t.push("m.megolm_backup.v1"),Object(w["a"])(e.secretStorage,t)}))()}bootstrapSecretStorage(){var e=arguments,t=this;return n()((function*(){var{createSecretStorageKey:r,setupNewSecretStorage:i,setupNewKeyBackup:n}=e.length>0&&void 0!==e[0]?e[0]:{},o=i||!(yield t.secretStorageHasAESKey());if(o){if(!r)throw new Error("unable to create a new secret storage key, createSecretStorageKey is not set");t.logger.info("bootstrapSecretStorage: creating new secret storage key");var s=yield r();yield t.addSecretStorageKeyToSecretStorage(s)}var a=yield t.olmMachine.crossSigningStatus(),c=a.hasMaster&&a.hasSelfSigning&&a.hasUserSigning;if(c&&(o||!(yield Object(w["b"])(t.secretStorage)))){t.logger.info("bootstrapSecretStorage: cross-signing keys not yet exported; doing so now.");var u=yield t.olmMachine.exportCrossSigningKeys();if(!u.masterKey)throw new Error("missing master key in cross signing private keys");if(!u.userSigningKey)throw new Error("missing user signing key in cross signing private keys");if(!u.self_signing_key)throw new Error("missing self signing key in cross signing private keys");yield t.secretStorage.store("m.cross_signing.master",u.masterKey),yield t.secretStorage.store("m.cross_signing.user_signing",u.userSigningKey),yield t.secretStorage.store("m.cross_signing.self_signing",u.self_signing_key)}n&&(yield t.resetKeyBackup())}))()}addSecretStorageKeyToSecretStorage(e){var t=this;return n()((function*(){var r,i,n,o,s=yield t.secretStorage.addKey(S["SECRET_STORAGE_ALGORITHM_V1_AES"],{passphrase:null===(r=e.keyInfo)||void 0===r?void 0:r.passphrase,name:null===(i=e.keyInfo)||void 0===i?void 0:i.name,key:e.privateKey});yield t.secretStorage.setDefaultKeyId(s.keyId),null===(n=(o=t.cryptoCallbacks).cacheSecretStorageKey)||void 0===n||n.call(o,s.keyId,s.keyInfo,e.privateKey)}))()}secretStorageHasAESKey(){var e=this;return n()((function*(){var t=yield e.secretStorage.getKey();if(!t)return!1;var[,r]=t;return r.algorithm===S["SECRET_STORAGE_ALGORITHM_V1_AES"]}))()}getCrossSigningStatus(){var e=this;return n()((function*(){var t=yield e.getOlmMachineOrThrow().getIdentity(new u["UserId"](e.userId)),r=Boolean(null===t||void 0===t?void 0:t.masterKey)&&Boolean(null===t||void 0===t?void 0:t.selfSigningKey)&&Boolean(null===t||void 0===t?void 0:t.userSigningKey);null===t||void 0===t||t.free();var i=yield Object(w["b"])(e.secretStorage),n=yield e.getOlmMachineOrThrow().crossSigningStatus();return{publicKeysOnDevice:r,privateKeysInSecretStorage:i,privateKeysCachedLocally:{masterKey:Boolean(null===n||void 0===n?void 0:n.hasMaster),userSigningKey:Boolean(null===n||void 0===n?void 0:n.hasUserSigning),selfSigningKey:Boolean(null===n||void 0===n?void 0:n.hasSelfSigning)}}}))()}createRecoveryKeyFromPassphrase(e){return n()((function*(){if(e){var t=yield Object(I["b"])(e);return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:t.iterations,salt:t.salt}},privateKey:t.key,encodedPrivateKey:Object(K["b"])(t.key)}}var r=new Uint8Array(32);return globalThis.crypto.getRandomValues(r),{privateKey:r,encodedPrivateKey:Object(K["b"])(r)}}))()}getEncryptionInfoForEvent(e){var t=this;return n()((function*(){return t.eventDecryptor.getEncryptionInfoForEvent(e)}))()}getVerificationRequestsToDeviceInProgress(e){var t=this.olmMachine.getVerificationRequests(new u["UserId"](e));return t.filter(e=>void 0===e.roomId).map(e=>new C["a"](this.olmMachine,e,this.outgoingRequestProcessor,this._supportedVerificationMethods))}findVerificationRequestDMInProgress(e,t){if(!t)throw new Error("missing userId");var r=this.olmMachine.getVerificationRequests(new u["UserId"](t)),i=r.find(t=>{var r;return(null===(r=t.roomId)||void 0===r?void 0:r.toString())===e});if(i)return new C["a"](this.olmMachine,i,this.outgoingRequestProcessor,this._supportedVerificationMethods)}requestVerificationDM(e,t){var r=this;return n()((function*(){var i=yield r.olmMachine.getIdentity(new u["UserId"](e));if(!i)throw new Error("unknown userId ".concat(e));try{var n=r._supportedVerificationMethods.map(e=>Object(C["c"])(e)),o=yield i.verificationRequestContent(n),s=yield r.sendVerificationRequestContent(t,o),a=yield i.requestVerification(new u["RoomId"](t),new u["EventId"](s),n);return new C["a"](r.olmMachine,a,r.outgoingRequestProcessor,r._supportedVerificationMethods)}finally{i.free()}}))()}sendVerificationRequestContent(e,t){var r=this;return n()((function*(){var i=Object(B["a"])(32),{event_id:n}=yield r.http.authedRequest(h["i"].Put,"/_matrix/client/v3/rooms/".concat(encodeURIComponent(e),"/send/m.room.message/").concat(encodeURIComponent(i)),void 0,t,{prefix:""});return n}))()}setSupportedVerificationMethods(e){this._supportedVerificationMethods=null!==e&&void 0!==e?e:x}requestOwnUserVerification(){var e=this;return n()((function*(){var t=yield e.olmMachine.getIdentity(new u["UserId"](e.userId));if(void 0===t)throw new Error("cannot request verification for this device when there is no existing cross-signing key");try{var[r,i]=yield t.requestVerification(e._supportedVerificationMethods.map(C["c"]));return yield e.outgoingRequestProcessor.makeOutgoingRequest(i),new C["a"](e.olmMachine,r,e.outgoingRequestProcessor,e._supportedVerificationMethods)}finally{t.free()}}))()}requestDeviceVerification(e,t){var r=this;return n()((function*(){var i=yield r.olmMachine.getDevice(new u["UserId"](e),new u["DeviceId"](t));if(!i)throw new Error("Not a known device");try{var[n,o]=i.requestVerification(r._supportedVerificationMethods.map(C["c"]));return yield r.outgoingRequestProcessor.makeOutgoingRequest(o),new C["a"](r.olmMachine,n,r.outgoingRequestProcessor,r._supportedVerificationMethods)}finally{i.free()}}))()}getSessionBackupPrivateKey(){var t=this;return n()((function*(){var r=yield t.olmMachine.getBackupKeys();return r.decryptionKey?e.from(r.decryptionKey.toBase64(),"base64"):null}))()}storeSessionBackupPrivateKey(e,t){var r=this;return n()((function*(){var i=Object(P["b"])(e);if(!t)throw new Error("storeSessionBackupPrivateKey: version is required");yield r.backupManager.saveBackupDecryptionKey(u["BackupDecryptionKey"].fromBase64(i),t)}))()}getActiveSessionBackupVersion(){var e=this;return n()((function*(){return yield e.backupManager.getActiveBackupVersion()}))()}isKeyBackupTrusted(e){var t=this;return n()((function*(){return yield t.backupManager.isKeyBackupTrusted(e)}))()}checkKeyBackupAndEnable(){var e=this;return n()((function*(){return yield e.backupManager.checkKeyBackupAndEnable(!0)}))()}deleteKeyBackupVersion(e){var t=this;return n()((function*(){yield t.backupManager.deleteKeyBackupVersion(e)}))()}resetKeyBackup(){var e=this;return n()((function*(){var t=yield e.backupManager.setupKeyBackup(t=>e.signObject(t));(yield e.secretStorageHasAESKey())&&(yield e.secretStorage.store("m.megolm_backup.v1",t.decryptionKey.toBase64())),e.checkKeyBackupAndEnable()}))()}signObject(e){var t=this;return n()((function*(){var r=new Map(Object.entries(e.signatures||{})),i=e.unsigned;delete e.signatures,delete e.unsigned;var n=r.get(t.userId)||{},o=c.a.stringify(e),s=yield t.olmMachine.sign(o),a=JSON.parse(s.asJSON());r.set(t.userId,j(j({},n),a[t.userId])),void 0!==i&&(e.unsigned=i),e.signatures=Object.fromEntries(r.entries())}))()}isDehydrationSupported(){var e=this;return n()((function*(){return yield e.dehydratedDeviceManager.isSupported()}))()}startDehydration(e){var t=this;return n()((function*(){if(!(yield t.isCrossSigningReady())||!(yield t.isSecretStorageReady()))throw new Error("Device dehydration requires cross-signing and secret storage to be set up");return yield t.dehydratedDeviceManager.start(e)}))()}importSecretsBundle(e){var t=this;return n()((function*(){var r=u["SecretsBundle"].from_json(e);yield t.getOlmMachineOrThrow().importSecretsBundle(r)}))()}exportSecretsBundle(){var e=this;return n()((function*(){var t=yield e.getOlmMachineOrThrow().exportSecretsBundle(),r=t.to_json();return t.free(),r}))()}receiveSyncChanges(e){var t=this;return n()((function*(){var{events:r,oneTimeKeysCounts:i=new Map,unusedFallbackKeys:o,devices:s=new u["DeviceLists"]}=e,a=yield Object(m["u"])(y["b"],"receiveSyncChanges",n()((function*(){return yield t.olmMachine.receiveSyncChanges(r?JSON.stringify(r):"[]",s,i,o)})));return JSON.parse(a)}))()}preprocessToDeviceMessages(e){var t=this;return n()((function*(){var r=yield t.receiveSyncChanges({events:e});for(var i of r)if(i.type===M["b"].KeyVerificationRequest){var n=i.sender,o=i.content.transaction_id;o&&n&&t.onIncomingKeyVerificationRequest(n,o)}return r}))()}processKeyCounts(e,t){var r=this;return n()((function*(){var i=e&&new Map(Object.entries(e)),n=t&&new Set(t);void 0===i&&void 0===n||(yield r.receiveSyncChanges({oneTimeKeysCounts:i,unusedFallbackKeys:n}))}))()}processDeviceLists(e){var t=this;return n()((function*(){var r,i,n=new u["DeviceLists"](null===(r=e.changed)||void 0===r?void 0:r.map(e=>new u["UserId"](e)),null===(i=e.left)||void 0===i?void 0:i.map(e=>new u["UserId"](e)));yield t.receiveSyncChanges({devices:n})}))()}onCryptoEvent(e,t){var r=this;return n()((function*(){var i=t.getContent(),n=new u["RoomSettings"];if("m.megolm.v1.aes-sha2"===i.algorithm){n.algorithm=u["EncryptionAlgorithm"].MegolmV1AesSha2;try{n.sessionRotationPeriodMs=i.rotation_period_ms,n.sessionRotationPeriodMessages=i.rotation_period_msgs,yield r.olmMachine.setRoomSettings(new u["RoomId"](e.roomId),n)}catch(s){return void r.logger.warn("Room ".concat(e.roomId,": ignoring crypto event which caused error: ").concat(s))}var o=r.roomEncryptors[e.roomId];o?o.onCryptoEvent(i):r.roomEncryptors[e.roomId]=new p["a"](r.olmMachine,r.keyClaimManager,r.outgoingRequestsManager,e,i)}else r.logger.warn("Room ".concat(e.roomId,": ignoring crypto event with invalid algorithm ").concat(i.algorithm))}))()}onSyncCompleted(e){this.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{this.logger.warn("onSyncCompleted: Error processing outgoing requests",e)})}onIncomingKeyVerificationRequest(e,t){var r=this.olmMachine.getVerificationRequest(new u["UserId"](e),t);r?this.emit(E["b"].VerificationRequestReceived,new C["a"](this.olmMachine,r,this.outgoingRequestProcessor,this._supportedVerificationMethods)):this.logger.info("Ignoring just-received verification request ".concat(t," which did not start a rust-side verification"))}onRoomMembership(e,t,r){var i=this.roomEncryptors[e.getRoomId()];i&&i.onRoomMembership(t)}onRoomKeysUpdated(e){var t=this;return n()((function*(){for(var r of e)t.onRoomKeyUpdated(r);t.backupManager.maybeUploadKey()}))()}onRoomKeyUpdated(e){var t=this;if(!this.stopped){this.logger.debug("Got update for session ".concat(e.senderKey.toBase64(),"|").concat(e.sessionId," in ").concat(e.roomId.toString()));var r=this.eventDecryptor.getEventsPendingRoomKey(e.roomId.toString(),e.sessionId);if(0!==r.length){this.logger.debug("Retrying decryption on events:",r.map(e=>"".concat(e.getId())));var i=function(e){e.attemptDecryption(t,{isRetry:!0}).catch(r=>{t.logger.info("Still unable to decrypt event ".concat(e.getId()," after receiving key"))})};for(var n of r)i(n)}}}onRoomKeysWithheld(e){var t=this;return n()((function*(){for(var r of e){t.logger.debug("Got withheld message for session ".concat(r.sessionId," in ").concat(r.roomId.toString()));var i=t.eventDecryptor.getEventsPendingRoomKey(r.roomId.toString(),r.sessionId);if(0===i.length)return;for(var n of(t.logger.debug("Retrying decryption on events:",i.map(e=>"".concat(e.getId()))),i))n.attemptDecryption(t,{isRetry:!0}).catch(e=>{})}}))()}onUserIdentityUpdated(e){var t=this;return n()((function*(){var r=yield t.getUserVerificationStatus(e.toString());t.emit(E["b"].UserTrustStatusChanged,e.toString(),r),e.toString()===t.userId&&(t.emit(E["b"].KeysChanged,{}),yield t.checkKeyBackupAndEnable())}))()}onDevicesUpdated(e){var t=this;return n()((function*(){t.emit(E["b"].WillUpdateDevices,e,!1),t.emit(E["b"].DevicesUpdated,e,!1)}))()}handleSecretReceived(e,t){var r=this;return n()((function*(){return r.logger.debug("onReceiveSecret: Received secret ".concat(e)),"m.megolm_backup.v1"===e&&(yield r.backupManager.handleBackupSecretReceived(t))}))()}checkSecrets(e){var t=this;return n()((function*(){var r=yield t.olmMachine.getSecretsFromInbox(e);for(var i of r)if(yield t.handleSecretReceived(e,i))break;yield t.olmMachine.deleteSecretsFromInbox(e)}))()}onLiveEventFromSync(e){var t=this;return n()((function*(){if(!e.isState()&&!e.getUnsigned().transaction_id){var r=function(){var r=n()((function*(r){Object(C["b"])(e)&&(yield t.onKeyVerificationEvent(r))}));return function(e){return r.apply(this,arguments)}}();if(e.isDecryptionFailure()||e.isEncrypted()){var i=3e5,o=setTimeout(()=>e.off(l["c"].Decrypted,s),i),s=(t,i)=>{i||(clearTimeout(o),e.off(l["c"].Decrypted,s),r(t))};e.on(l["c"].Decrypted,s)}else yield r(e)}}))()}onKeyVerificationEvent(e){var t=this;return n()((function*(){var r=e.getRoomId();if(!r)throw new Error("missing roomId in the event");t.logger.debug("Incoming verification event ".concat(e.getId()," type ").concat(e.getType()," from ").concat(e.getSender())),yield t.olmMachine.receiveVerificationEvent(JSON.stringify({event_id:e.getId(),type:e.getType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getContent(),origin_server_ts:e.getTs()}),new u["RoomId"](r)),e.getType()===M["b"].RoomMessage&&e.getContent().msgtype===M["e"].KeyVerificationRequest&&t.onIncomingKeyVerificationRequest(e.getSender(),e.getId()),t.outgoingRequestsManager.doProcessOutgoingRequests().catch(e=>{t.logger.warn("onKeyVerificationRequest: Error processing outgoing requests",e)})}))()}getOwnIdentity(){var e=this;return n()((function*(){return yield e.olmMachine.getIdentity(new u["UserId"](e.userId))}))()}}class F{constructor(e,t,r){this.logger=e,this.olmMachine=t,this.perSessionBackupDownloader=r,s()(this,"eventsPendingKey",new m["b"](()=>new m["b"](()=>new Set)))}attemptEventDecryption(e){var t=this;return n()((function*(){t.addEventToPendingList(e);try{var r=yield t.olmMachine.decryptRoomEvent(G(e),new u["RoomId"](e.getRoomId()));return t.removeEventFromPendingList(e),{clearEvent:JSON.parse(r.event),claimedEd25519Key:r.senderClaimedEd25519Key,senderCurve25519Key:r.senderCurve25519Key,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain}}catch(i){if(!(i instanceof u["MegolmDecryptionError"]))throw new g["a"](b["DecryptionFailureCode"].UNKNOWN_ERROR,"Unknown error");t.onMegolmDecryptionError(e,i,yield t.perSessionBackupDownloader.getServerBackupInfo())}}))()}onMegolmDecryptionError(e,t,r){var i=e.getWireContent(),n={session:i.sender_key+"|"+i.session_id};if(t.code===u["DecryptionErrorCode"].MissingRoomKey||t.code===u["DecryptionErrorCode"].UnknownMessageIndex){this.perSessionBackupDownloader.onDecryptionKeyMissingError(e.getRoomId(),i.session_id);var o=e.getMembershipAtEvent();if(o&&o!==d["a"].Join&&o!==d["a"].Invite)throw new g["a"](b["DecryptionFailureCode"].HISTORICAL_MESSAGE_USER_NOT_JOINED,"This message was sent when we were not a member of the room.",n);if(e.getTs()<=this.olmMachine.deviceCreationTimeMs)throw null===r?new g["a"](b["DecryptionFailureCode"].HISTORICAL_MESSAGE_NO_KEY_BACKUP,"This message was sent before this device logged in, and there is no key backup on the server.",n):this.perSessionBackupDownloader.isKeyBackupDownloadConfigured()?new g["a"](b["DecryptionFailureCode"].HISTORICAL_MESSAGE_WORKING_BACKUP,"This message was sent before this device logged in. Key backup is working, but we still do not (yet) have the key.",n):new g["a"](b["DecryptionFailureCode"].HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED,"This message was sent before this device logged in, and key backup is not working.",n)}if(t.maybe_withheld){var s="The sender has disabled encrypting to unverified devices."===t.maybe_withheld?b["DecryptionFailureCode"].MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:b["DecryptionFailureCode"].MEGOLM_KEY_WITHHELD;throw new g["a"](s,t.maybe_withheld,n)}switch(t.code){case u["DecryptionErrorCode"].MissingRoomKey:throw new g["a"](b["DecryptionFailureCode"].MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",n);case u["DecryptionErrorCode"].UnknownMessageIndex:throw new g["a"](b["DecryptionFailureCode"].OLM_UNKNOWN_MESSAGE_INDEX,"The sender's device has not sent us the keys for this message at this index.",n);default:throw new g["a"](b["DecryptionFailureCode"].UNKNOWN_ERROR,t.description,n)}}getEncryptionInfoForEvent(e){var t=this;return n()((function*(){if(!e.getClearContent()||e.isDecryptionFailure())return null;if(null!==e.status)return{shieldColour:b["EventShieldColour"].NONE,shieldReason:null};var r=yield t.olmMachine.getRoomEventEncryptionInfo(G(e),new u["RoomId"](e.getRoomId()));return W(t.logger,r)}))()}getEventsPendingRoomKey(e,t){var r=this.eventsPendingKey.get(e);if(!r)return[];var i=r.get(t);return i?[...i]:[]}addEventToPendingList(e){var t=e.getRoomId();if(t){var r=this.eventsPendingKey.getOrCreate(t),i=r.getOrCreate(e.getWireContent().session_id);i.add(e)}}removeEventFromPendingList(e){var t=e.getRoomId();if(t){var r=this.eventsPendingKey.getOrCreate(t);if(r){var i=r.get(e.getWireContent().session_id);i&&(i.delete(e),0===i.size&&(r.delete(e.getWireContent().session_id),0===r.size&&this.eventsPendingKey.delete(t)))}}}}function G(e){return JSON.stringify({event_id:e.getId(),type:e.getWireType(),sender:e.getSender(),state_key:e.getStateKey(),content:e.getWireContent(),origin_server_ts:e.getTs()})}function W(e,t){if(void 0===t)return null;var r,i,n=t.shieldState(!1);switch(n.color){case u["ShieldColor"].Grey:r=b["EventShieldColour"].GREY;break;case u["ShieldColor"].None:r=b["EventShieldColour"].NONE;break;default:r=b["EventShieldColour"].RED}return void 0===n.message?i=null:"Encrypted by an unverified user."===n.message?i=b["EventShieldReason"].UNVERIFIED_IDENTITY:"Encrypted by a device not verified by its owner."===n.message?i=b["EventShieldReason"].UNSIGNED_DEVICE:"The authenticity of this encrypted message can't be guaranteed on this device."===n.message?i=b["EventShieldReason"].AUTHENTICITY_NOT_GUARANTEED:"Encrypted by an unknown or deleted device."===n.message?i=b["EventShieldReason"].UNKNOWN_DEVICE:(e.warn("Unknown shield state message '".concat(n.message,"'")),i=b["EventShieldReason"].UNKNOWN),{shieldColour:r,shieldReason:i}}}).call(this,r("b639").Buffer)},"16b9":function(e,t,r){"use strict";r.d(t,"a",(function(){return y})),r.d(t,"b",(function(){return v}));r("14d9");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("700b"),c=r("0036"),u=r("be2e"),d=r("de1c"),l=r("0fc9"),g=r("67b8");class y extends l["b"]{constructor(e,t,r){super(),this.olmMachine=e,this.http=t,this.outgoingRequestProcessor=r,s()(this,"checkedForBackup",!1),s()(this,"serverBackupInfo",void 0),s()(this,"activeBackupVersion",null),s()(this,"stopped",!1),s()(this,"backupKeysLoopRunning",!1),s()(this,"keyBackupCheckInProgress",null)}stop(){this.stopped=!0}getActiveBackupVersion(){var e=this;return n()((function*(){return(yield e.olmMachine.isBackupEnabled())?e.activeBackupVersion:null}))()}getServerBackupInfo(){var e=this;return n()((function*(){return yield e.checkKeyBackupAndEnable(!1),e.serverBackupInfo}))()}isKeyBackupTrusted(e){var t=this;return n()((function*(){var r=yield t.olmMachine.verifyBackup(e),i=yield t.olmMachine.getBackupKeys(),n=null===i||void 0===i?void 0:i.decryptionKey,o=!!n&&h(e,n);return{matchesDecryptionKey:o,trusted:r.trusted()}}))()}checkKeyBackupAndEnable(e){return!e&&this.checkedForBackup?Promise.resolve(null):(this.keyBackupCheckInProgress||(this.keyBackupCheckInProgress=this.doCheckKeyBackup().finally(()=>{this.keyBackupCheckInProgress=null})),this.keyBackupCheckInProgress)}handleBackupSecretReceived(e){var t=this;return n()((function*(){var r,i=yield t.checkKeyBackupAndEnable(!0);if(null===i||void 0===i||null===(r=i.backupInfo)||void 0===r||!r.version||!i.trustInfo.trusted)return c["b"].warn("handleBackupSecretReceived: Received a backup decryption key, but there is no trusted server-side key backup"),!1;try{var n=a["BackupDecryptionKey"].fromBase64(e),o=h(i.backupInfo,n);return o?(c["b"].info("handleBackupSecretReceived: A valid backup decryption key has been received and stored in cache."),yield t.saveBackupDecryptionKey(n,i.backupInfo.version),!0):(c["b"].warn("handleBackupSecretReceived: Private decryption key does not match the public key of the current remote backup."),!1)}catch(s){c["b"].warn("handleBackupSecretReceived: Invalid backup decryption key",s)}return!1}))()}saveBackupDecryptionKey(e,t){var r=this;return n()((function*(){yield r.olmMachine.saveBackupDecryptionKey(e,t),r.emit(d["b"].KeyBackupDecryptionKeyCached,t)}))()}importRoomKeys(e,t){var r=this;return n()((function*(){yield r.importRoomKeysAsJson(JSON.stringify(e),t)}))()}importRoomKeysAsJson(e,t){var r=this;return n()((function*(){yield r.olmMachine.importExportedRoomKeys(e,(e,r)=>{var i,n={total:Number(r),successes:Number(e),stage:"load_keys",failures:0};null===t||void 0===t||null===(i=t.progressCallback)||void 0===i||i.call(t,n)})}))()}importBackedUpRoomKeys(e,t,r){var i=this;return n()((function*(){var n=new Map;for(var o of e){var s=new a["RoomId"](o.room_id);n.has(s)||n.set(s,new Map),n.get(s).set(o.session_id,o)}yield i.olmMachine.importBackedUpRoomKeys(n,(e,t,i)=>{var n,o={total:Number(t),successes:Number(e),stage:"load_keys",failures:Number(i)};null===r||void 0===r||null===(n=r.progressCallback)||void 0===n||n.call(r,o)},t)}))()}doCheckKeyBackup(){var e=this;return n()((function*(){var t;c["b"].log("Checking key backup status...");try{t=yield e.requestKeyBackupVersion()}catch(n){return c["b"].warn("Error checking for active key backup",n),e.serverBackupInfo=void 0,null}e.checkedForBackup=!0,t&&!t.version&&(c["b"].warn("active backup lacks a useful 'version'; ignoring it"),t=void 0),e.serverBackupInfo=t;var r=yield e.getActiveBackupVersion();if(!t)return null!==r?(c["b"].log("No key backup present on server: disabling key backup"),yield e.disableKeyBackup()):c["b"].log("No key backup present on server: not enabling key backup"),null;var i=yield e.isKeyBackupTrusted(t);return i.trusted?null===r?(c["b"].log("Found usable key backup v".concat(t.version,": enabling key backups")),yield e.enableKeyBackup(t)):r!==t.version?(c["b"].log("On backup version ".concat(r," but found version ").concat(t.version,": switching.")),yield e.disableKeyBackup(),yield e.enableKeyBackup(t)):c["b"].log("Backup version ".concat(t.version," still current")):null!==r?(c["b"].log("Key backup present on server but not trusted: disabling key backup"),yield e.disableKeyBackup()):c["b"].log("Key backup present on server but not trusted: not enabling key backup"),{backupInfo:t,trustInfo:i}}))()}enableKeyBackup(e){var t=this;return n()((function*(){yield t.olmMachine.enableBackupV1(e.auth_data.public_key,e.version),t.activeBackupVersion=e.version,t.emit(d["b"].KeyBackupStatus,!0),t.backupKeysLoop()}))()}maybeUploadKey(){var e=this;return n()((function*(){null!=e.activeBackupVersion&&e.backupKeysLoop()}))()}disableKeyBackup(){var e=this;return n()((function*(){yield e.olmMachine.disableBackup(),e.activeBackupVersion=null,e.emit(d["b"].KeyBackupStatus,!1)}))()}backupKeysLoop(){var e=arguments,t=this;return n()((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:1e4;if(t.backupKeysLoopRunning)c["b"].log("Backup loop already running");else{t.backupKeysLoopRunning=!0,c["b"].log("Backup: Starting keys upload loop for backup version:".concat(t.activeBackupVersion,"."));var i=Math.random()*r;yield Object(g["K"])(i);try{var o=0,s=null,a=!0;while(!t.stopped){var l=null;try{l=yield Object(g["u"])(c["b"],"BackupRoomKeys: Get keys to backup from rust crypto-sdk",n()((function*(){return yield t.olmMachine.backupRoomKeys()})))}catch(f){c["b"].error("Backup: Failed to get keys to backup from rust crypto-sdk",f)}if(!l||t.stopped||!t.activeBackupVersion)return c["b"].log("Backup: Ending loop for version ".concat(t.activeBackupVersion,".")),void(l||t.emit(d["b"].KeyBackupSessionsRemaining,0));try{if(yield t.outgoingRequestProcessor.makeOutgoingRequest(l),o=0,t.stopped)break;if(!a&&null===s)try{var y=yield t.olmMachine.roomKeyCounts();s=y.total-y.backedUp}catch(f){c["b"].error("Backup: Failed to get key counts from rust crypto-sdk",f)}if(null!==s){t.emit(d["b"].KeyBackupSessionsRemaining,s);var h=t.keysCountInBatch(l);s=Math.max(s-h,0)}}catch(f){if(o++,c["b"].error("Backup: Error processing backup request for rust crypto-sdk",f),f instanceof u["f"]){var p=f.data.errcode;if("M_NOT_FOUND"==p||"M_WRONG_ROOM_KEYS_VERSION"==p){c["b"].log("Backup: Failed to upload keys to current vesion: ".concat(p,"."));try{yield t.disableKeyBackup()}catch(m){c["b"].error("Backup: An error occurred while disabling key backup:",m)}return t.emit(d["b"].KeyBackupFailed,f.data.errcode),t.backupKeysLoopRunning=!1,void t.checkKeyBackupAndEnable(!0)}if("M_LIMIT_EXCEEDED"==p){var v=f.data.retry_after_ms;if(v>0){yield Object(g["K"])(v);continue}}}yield Object(g["K"])(1e3*Math.pow(2,Math.min(o-1,4)))}a=!1}}finally{t.backupKeysLoopRunning=!1}}}))()}keysCountInBatch(e){var t=JSON.parse(e.body),r=0;for(var{sessions:i}of Object.values(t.rooms))r+=Object.keys(i).length;return r}requestKeyBackupVersion(){var e=this;return n()((function*(){return yield v(e.http)}))()}setupKeyBackup(e){var t=this;return n()((function*(){yield t.deleteAllKeyBackupVersions();var r=a["BackupDecryptionKey"].createRandomKey(),i=r.megolmV1PublicKey,n={public_key:i.publicKeyBase64};yield e(n);var o=yield t.http.authedRequest(u["i"].Post,"/room_keys/version",void 0,{algorithm:i.algorithm,auth_data:n},{prefix:u["a"].V3});return yield t.saveBackupDecryptionKey(r,o.version),{version:o.version,algorithm:i.algorithm,authData:n,decryptionKey:r}}))()}deleteAllKeyBackupVersions(){var e=this;return n()((function*(){var t,r,i=null!==(t=null===(r=yield e.requestKeyBackupVersion())||void 0===r?void 0:r.version)&&void 0!==t?t:null;while(null!=i){var n,o;yield e.deleteKeyBackupVersion(i),i=null!==(n=null===(o=yield e.requestKeyBackupVersion())||void 0===o?void 0:o.version)&&void 0!==n?n:null}}))()}deleteKeyBackupVersion(e){var t=this;return n()((function*(){c["b"].debug("deleteKeyBackupVersion v:".concat(e));var r=Object(g["k"])("/room_keys/version/$version",{$version:e});yield t.http.authedRequest(u["i"].Delete,r,void 0,void 0,{prefix:u["a"].V3})}))()}createBackupDecryptor(e){return new p(e)}}function h(e,t){var r;return"m.megolm_backup.v1.curve25519-aes-sha2"!==e.algorithm?(c["b"].warn("backupMatchesPrivateKey: Unsupported backup algorithm",e.algorithm),!1):(null===(r=e.auth_data)||void 0===r?void 0:r.public_key)===t.megolmV1PublicKey.publicKeyBase64}class p{constructor(e){s()(this,"decryptionKey",void 0),s()(this,"sourceTrusted",void 0),this.decryptionKey=e,this.sourceTrusted=!1}decryptSessions(e){var t=this;return n()((function*(){var r=[];for(var[i,n]of Object.entries(e))try{var o=JSON.parse(t.decryptionKey.decryptV1(n.session_data.ephemeral,n.session_data.mac,n.session_data.ciphertext));o.session_id=i,r.push(o)}catch(s){c["b"].log("Failed to decrypt megolm session from backup",s,n)}return r}))()}free(){this.decryptionKey.free()}}function v(e){return f.apply(this,arguments)}function f(){return f=n()((function*(e){try{return yield e.authedRequest(u["i"].Get,"/room_keys/version",void 0,void 0,{prefix:u["a"].V3})}catch(t){if("M_NOT_FOUND"===t.errcode)return null;throw t}})),f.apply(this,arguments)}},"1d66":function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));r("d9e2");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o);class a{constructor(e,t){this.olmMachine=e,this.outgoingRequestProcessor=t,s()(this,"currentClaimPromise",void 0),s()(this,"stopped",!1),this.currentClaimPromise=Promise.resolve()}stop(){this.stopped=!0}ensureSessionsForUsers(e,t){var r=this.currentClaimPromise.catch(()=>{}).then(()=>this.ensureSessionsForUsersInner(e,t));return this.currentClaimPromise=r,r}ensureSessionsForUsersInner(e,t){var r=this;return n()((function*(){if(r.stopped)throw new Error("Cannot ensure Olm sessions: shutting down");e.info("Checking for missing Olm sessions");var i=yield r.olmMachine.getMissingSessions(t.map(e=>e.clone()));i&&(e.info("Making /keys/claim request"),yield r.outgoingRequestProcessor.makeOutgoingRequest(i)),e.info("Olm sessions prepared")}))()}}},"1fa7":function(e,t,r){"use strict";r.d(t,"a",(function(){return y}));r("d9e2");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("700b"),c=r("ee85"),u=r("0036"),d=r("fa64"),l=r("67b8"),g=r("b2e0");class y{constructor(e,t,r,i,n){this.olmMachine=e,this.keyClaimManager=t,this.outgoingRequestManager=r,this.room=i,this.encryptionSettings=n,s()(this,"prefixedLogger",void 0),s()(this,"lazyLoadedMembersResolved",!1),s()(this,"currentEncryptionPromise",Promise.resolve()),this.prefixedLogger=u["b"].getChild("[".concat(i.roomId," encryption]"));var o=i.getJoinedMembers();this.olmMachine.updateTrackedUsers(o.map(e=>new a["UserId"](e.userId))).catch(e=>this.prefixedLogger.error("Error initializing tracked users",e))}onCryptoEvent(e){if(JSON.stringify(this.encryptionSettings)!=JSON.stringify(e))throw new Error("Cannot reconfigure an active RoomEncryptor")}onRoomMembership(e){(e.membership==g["a"].Join||e.membership==g["a"].Invite&&this.room.shouldEncryptForInvitedMembers())&&this.olmMachine.updateTrackedUsers([new a["UserId"](e.userId)]).catch(e=>{this.prefixedLogger.error("Unable to update tracked users",e)})}prepareForEncryption(e){var t=this;return n()((function*(){yield t.encryptEvent(null,e)}))()}encryptEvent(e,t){var r,i=this,o=new u["a"](this.prefixedLogger,e?null!==(r=e.getTxnId())&&void 0!==r?r:"":"prepareForEncryption"),s=this.currentEncryptionPromise.catch(()=>{}).then(n()((function*(){yield Object(l["u"])(o,"ensureEncryptionSession",n()((function*(){yield i.ensureEncryptionSession(o,t)}))),e&&(yield Object(l["u"])(o,"encryptEventInner",n()((function*(){yield i.encryptEventInner(o,e)}))))})));return this.currentEncryptionPromise=s,s}ensureEncryptionSession(e,t){var r=this;return n()((function*(){var i;if("m.megolm.v1.aes-sha2"!==r.encryptionSettings.algorithm)throw new Error("Cannot encrypt in ".concat(r.room.roomId," for unsupported algorithm '").concat(r.encryptionSettings.algorithm,"'"));e.debug("Starting encryption");var o=yield r.room.getEncryptionTargetMembers();r.lazyLoadedMembersResolved?(e.debug("Processing outgoing requests in background"),r.outgoingRequestManager.doProcessOutgoingRequests()):(yield Object(l["u"])(r.prefixedLogger,"loadMembersIfNeeded: updateTrackedUsers",n()((function*(){yield r.olmMachine.updateTrackedUsers(o.map(e=>new a["UserId"](e.userId)))}))),e.debug("Updated tracked users"),r.lazyLoadedMembersResolved=!0,e.debug("Processing outgoing requests"),yield Object(l["u"])(r.prefixedLogger,"doProcessOutgoingRequests",n()((function*(){yield r.outgoingRequestManager.doProcessOutgoingRequests()})))),e.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(r.room.shouldEncryptForInvitedMembers(),"):"),o.map(e=>"".concat(e.userId," (").concat(e.membership,")")));var s=o.map(e=>new a["UserId"](e.userId));yield Object(l["u"])(r.prefixedLogger,"ensureSessionsForUsers",n()((function*(){yield r.keyClaimManager.ensureSessionsForUsers(e,s)})));var c=new a["EncryptionSettings"];c.historyVisibility=h(r.room.getHistoryVisibility()),c.algorithm=a["EncryptionAlgorithm"].MegolmV1AesSha2,"number"===typeof r.encryptionSettings.rotation_period_ms&&(c.rotationPeriod=BigInt(1e3*r.encryptionSettings.rotation_period_ms)),"number"===typeof r.encryptionSettings.rotation_period_msgs&&(c.rotationPeriodMessages=BigInt(r.encryptionSettings.rotation_period_msgs)),(null!==(i=r.room.getBlacklistUnverifiedDevices())&&void 0!==i?i:t)?c.sharingStrategy=a["CollectStrategy"].DeviceBasedStrategyOnlyTrustedDevices:c.sharingStrategy=a["CollectStrategy"].DeviceBasedStrategyAllDevices,yield Object(l["u"])(r.prefixedLogger,"shareRoomKey",n()((function*(){var e=yield r.olmMachine.shareRoomKey(new a["RoomId"](r.room.roomId),s,c);if(e)for(var t of e)yield r.outgoingRequestManager.outgoingRequestProcessor.makeOutgoingRequest(t)})))}))()}forceDiscardSession(){var e=this;return n()((function*(){var t=yield e.olmMachine.invalidateGroupSession(new a["RoomId"](e.room.roomId));t&&e.prefixedLogger.info("Discarded existing group session")}))()}encryptEventInner(e,t){var r=this;return n()((function*(){e.debug("Encrypting actual message content");var i=yield r.olmMachine.encryptRoomEvent(new a["RoomId"](r.room.roomId),t.getType(),JSON.stringify(t.getContent()));t.makeEncrypted(c["b"].RoomMessageEncrypted,JSON.parse(i),r.olmMachine.identityKeys.curve25519.toBase64(),r.olmMachine.identityKeys.ed25519.toBase64()),e.debug("Encrypted event successfully")}))()}}function h(e){switch(e){case d["b"].Invited:return a["HistoryVisibility"].Invited;case d["b"].Joined:return a["HistoryVisibility"].Joined;case d["b"].Shared:return a["HistoryVisibility"].Shared;case d["b"].WorldReadable:return a["HistoryVisibility"].WorldReadable}}},"2f97":function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));r("d9e2"),r("14d9");var i,n=r("fbe9"),o=r.n(n),s=r("054a"),a=r.n(s),c=r("be2e"),u=r("7bf3"),d=r("67b8"),l=5e3;(function(e){e["MISSING_DECRYPTION_KEY"]="MISSING_DECRYPTION_KEY",e["NETWORK_ERROR"]="NETWORK_ERROR",e["STOPPED"]="STOPPED"})(i||(i={}));class g extends Error{constructor(e){super("Failed to get key from backup: ".concat(e)),this.code=e,this.name="KeyDownloadError"}}class y extends Error{constructor(e){super("Failed to get key from backup: rate limited"),this.retryMillis=e,this.name="KeyDownloadRateLimitError"}}class h{constructor(e,t,r,i){this.olmMachine=t,this.http=r,this.backupManager=i,a()(this,"stopped",!1),a()(this,"configuration",null),a()(this,"sessionLastCheckAttemptedTime",new Map),a()(this,"logger",void 0),a()(this,"downloadLoopRunning",!1),a()(this,"queuedRequests",[]),a()(this,"hasConfigurationProblem",!1),a()(this,"currentBackupVersionCheck",null),a()(this,"onBackupStatusChanged",()=>{this.hasConfigurationProblem=!1,this.configuration=null,this.getOrCreateBackupConfiguration().then(e=>{e&&this.downloadKeysLoop()})}),this.logger=e.getChild("[PerSessionKeyBackupDownloader]"),i.on(u["CryptoEvent"].KeyBackupStatus,this.onBackupStatusChanged),i.on(u["CryptoEvent"].KeyBackupFailed,this.onBackupStatusChanged),i.on(u["CryptoEvent"].KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}isKeyBackupDownloadConfigured(){return null!==this.configuration}getServerBackupInfo(){var e=this;return o()((function*(){return yield e.backupManager.getServerBackupInfo()}))()}onDecryptionKeyMissingError(e,t){this.isAlreadyInQueue(e,t)?this.logger.trace("Not checking key backup for session ".concat(t," as it is already queued")):this.wasRequestedRecently(t)?this.logger.trace("Not checking key backup for session ".concat(t," as it was already requested recently")):(this.queuedRequests.push({roomId:e,megolmSessionId:t}),this.downloadKeysLoop())}stop(){this.stopped=!0,this.backupManager.off(u["CryptoEvent"].KeyBackupStatus,this.onBackupStatusChanged),this.backupManager.off(u["CryptoEvent"].KeyBackupFailed,this.onBackupStatusChanged),this.backupManager.off(u["CryptoEvent"].KeyBackupDecryptionKeyCached,this.onBackupStatusChanged)}isAlreadyInQueue(e,t){return this.queuedRequests.some(r=>r.roomId==e&&r.megolmSessionId==t)}markAsNotFoundInBackup(e){var t=Date.now();this.sessionLastCheckAttemptedTime.set(e,t),this.sessionLastCheckAttemptedTime.size>100&&(this.sessionLastCheckAttemptedTime=new Map(Array.from(this.sessionLastCheckAttemptedTime).filter((e,r)=>Math.max(t-r,0)<l)))}wasRequestedRecently(e){var t=this.sessionLastCheckAttemptedTime.get(e);return!!t&&Math.max(Date.now()-t,0)<l}getBackupDecryptionKey(){var e=this;return o()((function*(){try{return yield e.olmMachine.getBackupKeys()}catch(t){return null}}))()}requestRoomKeyFromBackup(e,t,r){var i=this;return o()((function*(){var n=Object(d["k"])("/room_keys/keys/$roomId/$sessionId",{$roomId:t,$sessionId:r});return yield i.http.authedRequest(c["i"].Get,n,{version:e},void 0,{prefix:c["a"].V3})}))()}downloadKeysLoop(){var e=this;return o()((function*(){if(!e.downloadLoopRunning&&!e.hasConfigurationProblem){e.downloadLoopRunning=!0;try{while(e.queuedRequests.length>0){var t=e.queuedRequests[0];try{var r=yield e.getOrCreateBackupConfiguration();if(!r)return void(e.downloadLoopRunning=!1);var n=yield e.queryKeyBackup(t.roomId,t.megolmSessionId,r);if(e.stopped)return;try{yield e.decryptAndImport(t,n,r)}catch(o){e.logger.error("Error while decrypting and importing key backup for session ".concat(t.megolmSessionId),o)}e.queuedRequests.shift()}catch(s){if(s instanceof g)switch(s.code){case i.MISSING_DECRYPTION_KEY:e.markAsNotFoundInBackup(t.megolmSessionId),e.queuedRequests.shift();break;case i.NETWORK_ERROR:yield Object(d["K"])(l);break;case i.STOPPED:return void(e.downloadLoopRunning=!1)}else s instanceof y&&(yield Object(d["K"])(s.retryMillis))}}}finally{e.downloadLoopRunning=!1}}}))()}queryKeyBackup(e,t,r){var n=this;return o()((function*(){if(n.logger.debug("Checking key backup for session ".concat(t)),n.stopped)throw new g(i.STOPPED);try{var o=yield n.requestRoomKeyFromBackup(r.backupVersion,e,t);return n.logger.debug("Got key from backup for sessionId:".concat(t)),o}catch(u){if(n.stopped)throw new g(i.STOPPED);if(n.logger.info("No luck requesting key backup for session ".concat(t,": ").concat(u)),u instanceof c["f"]){var s=u.data.errcode;if("M_NOT_FOUND"==s)throw new g(i.MISSING_DECRYPTION_KEY);if("M_LIMIT_EXCEEDED"==s){var a=u.data.retry_after_ms;throw a>0?(n.logger.info("Rate limited by server, waiting ".concat(a,"ms")),new y(a)):new y(l)}}throw new g(i.NETWORK_ERROR)}}))()}decryptAndImport(e,t,r){var i=this;return o()((function*(){var n={[e.megolmSessionId]:t},o=yield r.decryptor.decryptSessions(n);for(var s of o)s.room_id=e.roomId;yield i.backupManager.importBackedUpRoomKeys(o,r.backupVersion)}))()}getOrCreateBackupConfiguration(){var e=this;return o()((function*(){if(e.configuration)return e.configuration;if(e.hasConfigurationProblem)return null;if(null!=e.currentBackupVersionCheck)return e.logger.debug("Already checking server version, use current promise"),yield e.currentBackupVersionCheck;e.currentBackupVersionCheck=e.internalCheckFromServer();try{return yield e.currentBackupVersionCheck}finally{e.currentBackupVersionCheck=null}}))()}internalCheckFromServer(){var e=this;return o()((function*(){var t,r,i,n,o=null;try{o=yield e.backupManager.getServerBackupInfo()}catch(d){return e.logger.debug("Backup: error while checking server version: ".concat(d)),e.hasConfigurationProblem=!0,null}if(e.logger.debug("Got current backup version from server: ".concat(null===(t=o)||void 0===t?void 0:t.version)),"m.megolm_backup.v1.curve25519-aes-sha2"!=(null===(r=o)||void 0===r?void 0:r.algorithm))return e.logger.info("Unsupported algorithm ".concat(null===(n=o)||void 0===n?void 0:n.algorithm)),e.hasConfigurationProblem=!0,null;if(null===(i=o)||void 0===i||!i.version)return e.logger.info("No current key backup"),e.hasConfigurationProblem=!0,null;var s=yield e.backupManager.getActiveBackupVersion();if(null==s||o.version!=s)return e.logger.info("The current backup version on the server (".concat(o.version,") is not trusted. Version we are currently backing up to: ").concat(s)),e.hasConfigurationProblem=!0,null;var a=o.auth_data,c=yield e.getBackupDecryptionKey();if(null===c||void 0===c||!c.decryptionKey)return e.logger.debug("Not checking key backup for session (no decryption key)"),e.hasConfigurationProblem=!0,null;if(s!=c.backupVersion)return e.logger.debug("Version for which we have a decryption key (".concat(c.backupVersion,") doesn't match the version we are backing up to (").concat(s,")")),e.hasConfigurationProblem=!0,null;if(a.public_key!=c.decryptionKey.megolmV1PublicKey.publicKeyBase64)return e.logger.debug("getBackupDecryptor key mismatch error"),e.hasConfigurationProblem=!0,null;var u=e.backupManager.createBackupDecryptor(c.decryptionKey);return e.hasConfigurationProblem=!1,e.configuration={decryptor:u,backupVersion:s},e.configuration}))()}}},"6f26":function(e,t,r){"use strict";r.d(t,"b",(function(){return o})),r.d(t,"a",(function(){return s}));r("88e6"),r("70cc"),r("eb03"),r("22e5"),r("c01e"),r("fa76"),r("8306");var i=r("700b"),n=r("a819");function o(e,t){var r=new Map;for(var[o,s]of e.keys.entries())r.set(o.toString(),s.toBase64());var a=n["b"].Unverified;e.isBlacklisted()?a=n["b"].Blocked:e.isVerified()&&(a=n["b"].Verified);var c=new Map,u=e.signatures.get(t);if(u){var d=new Map;for(var[l,g]of u.entries())g.isValid()&&g.signature&&d.set(l,g.signature.toBase64());c.set(t.toString(),d)}var y=e.algorithms,h=new Set;return y.forEach(e=>{switch(e){case i["EncryptionAlgorithm"].MegolmV1AesSha2:h.add("m.megolm.v1.aes-sha2");break;case i["EncryptionAlgorithm"].OlmV1Curve25519AesSha2:default:h.add("m.olm.v1.curve25519-aes-sha2");break}}),new n["a"]({deviceId:e.deviceId.toString(),userId:t.toString(),keys:r,algorithms:Array.from(h),verified:a,signatures:c,displayName:e.displayName,dehydrated:e.isDehydrated})}function s(e){return new Map(Object.entries(e).map(e=>{var[t,r]=e;return[t,a(r)]}))}function a(e){var t,r=new Map(Object.entries(e.keys)),i=null===(t=e.unsigned)||void 0===t?void 0:t.device_display_name,o=new Map;if(e.signatures)for(var s in e.signatures)o.set(s,new Map(Object.entries(e.signatures[s])));return new n["a"]({deviceId:e.device_id,userId:e.user_id,keys:r,algorithms:e.algorithms,verified:n["b"].Unverified,signatures:o,displayName:i})}},"99d8":function(e,t,r){"use strict";r.r(t),r.d(t,"initRustCrypto",(function(){return V}));r("14d9");var i=r("054a"),n=r.n(i),o=r("fbe9"),s=r.n(o),a=r("700b"),c=r("0877"),u=r("10fc"),d=(r("2c66"),r("249d"),r("40e9"),r("907a"),r("986a"),r("1d02"),r("3c5d"),r("6ce5"),r("2834"),r("4ea1"),r("f3e8")),l=r("df78"),g=r("16b9"),y=r("67b8"),h=r("ac66");function p(e){return v.apply(this,arguments)}function v(){return v=s()((function*(e){var t,{logger:r,legacyStore:i}=e;if(yield a["initAsync"](),new a["Tracing"](a["LoggerLevel"].Debug).turnOn(),yield i.containsData()){yield i.startup();var n=null;if(yield i.doTxn("readonly",[d["a"].STORE_ACCOUNT],e=>{i.getAccount(e,e=>{n=e})}),n){var o=yield i.getMigrationState();if(!(o>=u["b"].MEGOLM_SESSIONS_MIGRATED)){var s=yield b(r,i),c=yield S(r,i),l=1+s+c;r.info("Migrating data from legacy crypto store. ".concat(s," olm sessions and ").concat(c," megolm sessions to migrate."));var g=0;h(0);var y=(new TextEncoder).encode(e.legacyPickleKey);o===u["b"].NOT_STARTED&&(r.info("Migrating data from legacy crypto store. Step 1: base data"),yield f(e.http,e.userId,e.deviceId,i,y,e.storeHandle,r),o=u["b"].INITIAL_DATA_MIGRATED,yield i.setMigrationState(o)),h(1),o===u["b"].INITIAL_DATA_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 2: olm sessions (".concat(s," sessions to migrate).")),yield w(r,i,y,e.storeHandle,h),o=u["b"].OLM_SESSIONS_MIGRATED,yield i.setMigrationState(o)),o===u["b"].OLM_SESSIONS_MIGRATED&&(r.info("Migrating data from legacy crypto store. Step 3: megolm sessions (".concat(c," sessions to migrate).")),yield K(r,i,y,e.storeHandle,h),o=u["b"].MEGOLM_SESSIONS_MIGRATED,yield i.setMigrationState(o)),null===(t=e.legacyMigrationProgressListener)||void 0===t||t.call(e,-1,-1),r.info("Migration from legacy crypto store complete")}}else r.debug("Legacy crypto store is not set up (no account found). Not migrating.")}function h(t){var r;g+=t,null===(r=e.legacyMigrationProgressListener)||void 0===r||r.call(e,g,l)}})),v.apply(this,arguments)}function f(e,t,r,i,n,o,s){return m.apply(this,arguments)}function m(){return m=s()((function*(e,t,r,i,n,o,s){var c=new a["BaseMigrationData"];c.userId=new a["UserId"](t),c.deviceId=new a["DeviceId"](r),yield i.doTxn("readonly",[d["a"].STORE_ACCOUNT],e=>i.getAccount(e,e=>{c.pickledAccount=null!==e&&void 0!==e?e:""}));var u=yield O(i,n,"m.megolm_backup.v1");if(u){var l=!1,h=null;while(!l)try{h=yield Object(g["b"])(e),l=!0}catch(b){s.info("Failed to get backup version during migration, retrying in 2 seconds",b),yield Object(y["K"])(2e3)}if(h&&"m.megolm_backup.v1.curve25519-aes-sha2"==h.algorithm)try{var p,v=a["BackupDecryptionKey"].fromBase64(u),f=null===(p=h.auth_data)||void 0===p?void 0:p.public_key,m=v.megolmV1PublicKey.publicKeyBase64==f;m?(c.backupVersion=h.version,c.backupRecoveryKey=u):s.debug("The backup key to migrate does not match the active backup version","Cached pub key: ".concat(v.megolmV1PublicKey.publicKeyBase64),"Active pub key: ".concat(f))}catch(b){s.warn("Failed to check if the backup key to migrate matches the active backup version",b)}}c.privateCrossSigningMasterKey=yield O(i,n,"master"),c.privateCrossSigningSelfSigningKey=yield O(i,n,"self_signing"),c.privateCrossSigningUserSigningKey=yield O(i,n,"user_signing"),yield a["Migration"].migrateBaseData(c,n,o)})),m.apply(this,arguments)}function b(e,t){return k.apply(this,arguments)}function k(){return k=s()((function*(e,t){var r;return e.debug("Counting olm sessions to be migrated"),yield t.doTxn("readonly",[d["a"].STORE_SESSIONS],e=>t.countEndToEndSessions(e,e=>r=e)),r})),k.apply(this,arguments)}function S(e,t){return R.apply(this,arguments)}function R(){return R=s()((function*(e,t){return e.debug("Counting megolm sessions to be migrated"),yield t.countEndToEndInboundGroupSessions()})),R.apply(this,arguments)}function w(e,t,r,i,n){return I.apply(this,arguments)}function I(){return I=s()((function*(e,t,r,i,n){while(1){var o=yield t.getEndToEndSessionsBatch();if(null===o)return;e.debug("Migrating batch of ".concat(o.length," olm sessions"));var s=[];for(var c of o){var u=new a["PickledSession"];u.senderKey=c.deviceKey,u.pickle=c.session,u.lastUseTime=u.creationTime=new Date(c.lastReceivedMessageTs),s.push(u)}yield a["Migration"].migrateOlmSessions(s,r,i),yield t.deleteEndToEndSessionsBatch(o),n(o.length)}})),I.apply(this,arguments)}function K(e,t,r,i,n){return C.apply(this,arguments)}function C(){return C=s()((function*(e,t,r,i,n){while(1){var o=yield t.getEndToEndInboundGroupSessionsBatch();if(null===o)return;e.debug("Migrating batch of ".concat(o.length," megolm sessions"));var s=[];for(var c of o){var u,d=c.sessionData,l=new a["PickledInboundGroupSession"];l.pickle=d.session,l.roomId=new a["RoomId"](d.room_id),l.senderKey=c.senderKey,l.senderSigningKey=null===(u=d.keysClaimed)||void 0===u?void 0:u["ed25519"],l.backedUp=!c.needsBackup,l.imported=!0===d.untrusted,s.push(l)}yield a["Migration"].migrateMegolmSessions(s,r,i),yield t.deleteEndToEndInboundGroupSessionsBatch(o),n(o.length)}})),C.apply(this,arguments)}function M(e){return E.apply(this,arguments)}function E(){return E=s()((function*(e){var{logger:t,legacyStore:r,olmMachine:i}=e;if(yield r.containsData()){var n=yield r.getMigrationState();if(!(n>=u["b"].ROOM_SETTINGS_MIGRATED)){var o={};for(var[s,c]of(yield r.doTxn("readwrite",[d["a"].STORE_ROOMS],e=>{r.getEndToEndRooms(e,e=>{o=e})}),t.debug("Migrating ".concat(Object.keys(o).length," sets of room settings")),Object.entries(o)))try{var l=new a["RoomSettings"];if("m.megolm.v1.aes-sha2"!==c.algorithm){t.warn("Room ".concat(s,": ignoring room with invalid algorithm ").concat(c.algorithm));continue}l.algorithm=a["EncryptionAlgorithm"].MegolmV1AesSha2,l.sessionRotationPeriodMs=c.rotation_period_ms,l.sessionRotationPeriodMessages=c.rotation_period_msgs,yield i.setRoomSettings(new a["RoomId"](s),l)}catch(g){t.warn("Room ".concat(s,": ignoring settings ").concat(JSON.stringify(c)," which caused error ").concat(g))}t.debug("Completed room settings migration"),yield r.setMigrationState(u["b"].ROOM_SETTINGS_MIGRATED)}}})),E.apply(this,arguments)}function O(e,t,r){return _.apply(this,arguments)}function _(){return _=s()((function*(e,t,r){var i=yield new Promise(t=>{e.doTxn("readonly",[d["a"].STORE_ACCOUNT],i=>{e.getSecretStorePrivateKey(i,t,r)})});return i&&i.ciphertext&&i.iv&&i.mac?yield Object(l["b"])(i,t,r):i instanceof Uint8Array?Object(h["b"])(i):void 0})),_.apply(this,arguments)}function D(e){return B.apply(this,arguments)}function B(){return B=s()((function*(e){var{legacyCryptoStore:t,rustCrypto:r,logger:i}=e,n=yield r.getOwnIdentity();if(n&&!n.isVerified()){var o=yield q(t);if(o){var s=JSON.parse(n.masterKey);if(s.keys&&0!==Object.keys(s.keys).length){var a=Object.values(s.keys)[0];a&&a==o&&(i.info("Post Migration: Migrating legacy trusted MSK: ".concat(o," to locally verified.")),yield n.verify())}else i.error("Post Migration | Unexpected error: no master key in the rust session.")}}})),B.apply(this,arguments)}function q(e){return P.apply(this,arguments)}function P(){return P=s()((function*(e){var t=null;return yield e.doTxn("readonly","account",r=>{e.getCrossSigningKeys(r,e=>{var r=null===e||void 0===e?void 0:e.master;r&&0!=Object.keys(r.keys).length&&(t=Object.values(r.keys)[0])})}),t})),P.apply(this,arguments)}function U(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function T(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?U(Object(r),!0).forEach((function(t){n()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):U(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function V(e){return N.apply(this,arguments)}function N(){return N=s()((function*(e){var t,{logger:r}=e;r.debug("Initialising Rust crypto-sdk WASM artifact"),yield a["initAsync"](),new a["Tracing"](a["LoggerLevel"].Debug).turnOn(),r.debug("Opening Rust CryptoStore"),t=e.storePrefix?e.storeKey?yield a["StoreHandle"].openWithKey(e.storePrefix,e.storeKey):yield a["StoreHandle"].open(e.storePrefix,e.storePassphrase):yield a["StoreHandle"].open(),e.legacyCryptoStore&&(yield p(T({legacyStore:e.legacyCryptoStore,storeHandle:t},e)));var i=yield A(r,e.http,e.userId,e.deviceId,e.secretStorage,e.cryptoCallbacks,t,e.legacyCryptoStore);return t.free(),r.debug("Completed rust crypto-sdk setup"),i})),N.apply(this,arguments)}function A(e,t,r,i,n,o,s,a){return j.apply(this,arguments)}function j(){return j=s()((function*(e,t,r,i,n,o,s,d){e.debug("Init OlmMachine");var l=yield a["OlmMachine"].initFromStore(new a["UserId"](r),new a["DeviceId"](i),s);d&&(yield M({logger:e,legacyStore:d,olmMachine:l})),l.roomKeyRequestsEnabled=!1;var g=new c["a"](e,l,t,r,i,n,o);if(yield l.registerRoomKeyUpdatedCallback(e=>g.onRoomKeysUpdated(e)),yield l.registerRoomKeysWithheldCallback(e=>g.onRoomKeysWithheld(e)),yield l.registerUserIdentityUpdatedCallback(e=>g.onUserIdentityUpdated(e)),yield l.registerDevicesUpdatedCallback(e=>g.onDevicesUpdated(e)),g.checkSecrets("m.megolm_backup.v1"),yield l.registerReceiveSecretCallback((e,t)=>g.checkSecrets(e)),yield l.outgoingRequests(),d&&(yield d.containsData())){var y=yield d.getMigrationState();if(y<u["b"].INITIAL_OWN_KEY_QUERY_DONE){e.debug("Performing initial key query after migration");var h=!1;while(!h)try{yield g.userHasCrossSigningKeys(r),h=!0}catch(p){e.error("Failed to check for cross-signing keys after migration, retrying",p)}yield D({legacyCryptoStore:d,rustCrypto:g,logger:e}),yield d.setMigrationState(u["b"].INITIAL_OWN_KEY_QUERY_DONE)}}return g})),j.apply(this,arguments)}},"9eee":function(e,t,r){"use strict";r.d(t,"a",(function(){return p}));r("d9e2"),r("14d9");var i=r("054a"),n=r.n(i),o=r("fbe9"),s=r.n(o),a=r("700b"),c=r("0036"),u=r("be2e"),d=r("67b8"),l=r("ee85"),g=r("eb1f");function y(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?y(Object(r),!0).forEach((function(t){n()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):y(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class p{constructor(e,t){this.olmMachine=e,this.http=t}makeOutgoingRequest(e,t){var r=this;return s()((function*(){var i;if(e instanceof a["KeysUploadRequest"])i=yield r.requestWithRetry(u["i"].Post,"/_matrix/client/v3/keys/upload",{},e.body);else if(e instanceof a["KeysQueryRequest"])i=yield r.requestWithRetry(u["i"].Post,"/_matrix/client/v3/keys/query",{},e.body);else if(e instanceof a["KeysClaimRequest"])i=yield r.requestWithRetry(u["i"].Post,"/_matrix/client/v3/keys/claim",{},e.body);else if(e instanceof a["SignatureUploadRequest"])i=yield r.requestWithRetry(u["i"].Post,"/_matrix/client/v3/keys/signatures/upload",{},e.body);else if(e instanceof a["KeysBackupRequest"])i=yield r.requestWithRetry(u["i"].Put,"/_matrix/client/v3/room_keys/keys",{version:e.version},e.body);else if(e instanceof a["ToDeviceRequest"])i=yield r.sendToDeviceRequest(e);else if(e instanceof a["RoomMessageRequest"]){var n="/_matrix/client/v3/rooms/".concat(encodeURIComponent(e.room_id),"/send/")+"".concat(encodeURIComponent(e.event_type),"/").concat(encodeURIComponent(e.txn_id));i=yield r.requestWithRetry(u["i"].Put,n,{},e.body)}else{if(e instanceof a["UploadSigningKeysRequest"])return void(yield r.makeRequestWithUIA(u["i"].Post,"/_matrix/client/v3/keys/device_signing/upload",{},e.body,t));if(e instanceof a["PutDehydratedDeviceRequest"]){var o=g["b"]+"/dehydrated_device";return void(yield r.rawJsonRequest(u["i"].Put,o,{},e.body))}c["b"].warn("Unsupported outgoing message",Object.getPrototypeOf(e)),i=""}if(e.id)try{yield Object(d["u"])(c["b"],"Mark Request as sent ".concat(e.type),s()((function*(){yield r.olmMachine.markRequestAsSent(e.id,e.type,i)})))}catch(l){if(!(l instanceof Error)||"Attempt to use a moved value"!==l.message&&"null pointer passed to rust"!==l.message)throw l;c["b"].log("Ignoring error '".concat(l.message,"': client is likely shutting down"))}else c["b"].trace("Outgoing request type:".concat(e.type," does not have an ID"))}))()}sendToDeviceRequest(e){var t=this;return s()((function*(){var r=JSON.parse(e.body),i=[];for(var[n,o]of Object.entries(r.messages))for(var[s,a]of Object.entries(o))i.push("".concat(n,"/").concat(s," (msgid ").concat(a[l["k"]],")"));c["b"].info("Sending batch of to-device messages. type=".concat(e.event_type," txnid=").concat(e.txn_id),i);var d="/_matrix/client/v3/sendToDevice/".concat(encodeURIComponent(e.event_type),"/")+encodeURIComponent(e.txn_id);return yield t.requestWithRetry(u["i"].Put,d,{},e.body)}))()}makeRequestWithUIA(e,t,r,i,n){var o=this;return s()((function*(){if(!n)return yield o.requestWithRetry(e,t,r,i);var a=JSON.parse(i),c=function(){var i=s()((function*(i){var n=h({},a);null!==i&&(n.auth=i);var s=yield o.requestWithRetry(e,t,r,JSON.stringify(n));return JSON.parse(s)}));return function(e){return i.apply(this,arguments)}}(),u=yield n(c);return JSON.stringify(u)}))()}requestWithRetry(e,t,r,i){var n=this;return s()((function*(){var o=0;while(1)try{return yield n.rawJsonRequest(e,t,r,i)}catch(a){o++;var s=Object(u["k"])(a,o,!0);if(s<0)throw a;yield Object(d["K"])(s)}}))()}rawJsonRequest(e,t,r,i){var n=this;return s()((function*(){var o={json:!1,headers:{"Content-Type":"application/json",Accept:"application/json"},prefix:""};return yield n.http.authedRequest(e,t,r,i,o)}))()}}},bf66:function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return h})),r.d(t,"c",(function(){return b})),r.d(t,"b",(function(){return k}));r("d9e2"),r("2c66"),r("249d"),r("40e9"),r("907a"),r("986a"),r("1d02"),r("3c5d"),r("6ce5"),r("2834"),r("4ea1");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("700b"),c=r("2139"),u=r("0fc9"),d=r("8d85"),l=r("ee85"),g=r("67b8"),y=r("6c93");class h extends u["b"]{constructor(e,t,r,i){super(),this.olmMachine=e,this.inner=t,this.outgoingRequestProcessor=r,this.supportedVerificationMethods=i,s()(this,"reEmitter",void 0),s()(this,"_accepting",!1),s()(this,"_cancelling",!1),s()(this,"_verifier",void 0),this.reEmitter=new d["b"](this);var o=new WeakRef(this);t.registerChangesCallback(n()((function*(){var e;return null===(e=o.deref())||void 0===e?void 0:e.onChange()})))}onChange(){var e=this.inner.getVerification();e instanceof a["Sas"]?void 0===this._verifier||this._verifier instanceof v?this.setVerifier(new f(e,this,this.outgoingRequestProcessor)):this._verifier instanceof f&&this._verifier.replaceInner(e):e instanceof a["Qr"]&&void 0===this._verifier&&this.setVerifier(new v(e,this.outgoingRequestProcessor)),this.emit(c["b"].Change)}setVerifier(e){this._verifier&&this.reEmitter.stopReEmitting(this._verifier,[c["b"].Change]),this._verifier=e,this.reEmitter.reEmit(this._verifier,[c["b"].Change])}get transactionId(){return this.inner.flowId}get roomId(){var e;return null===(e=this.inner.roomId)||void 0===e?void 0:e.toString()}get initiatedByMe(){return this.inner.weStarted()}get otherUserId(){return this.inner.otherUserId.toString()}get otherDeviceId(){var e;return null===(e=this.inner.otherDeviceId)||void 0===e?void 0:e.toString()}getOtherDevice(){var e=this;return n()((function*(){var t=e.inner.otherDeviceId;if(t)return yield e.olmMachine.getDevice(e.inner.otherUserId,t,5)}))()}get isSelfVerification(){return this.inner.isSelfVerification()}get phase(){var e=this.inner.phase();switch(e){case a["VerificationRequestPhase"].Created:case a["VerificationRequestPhase"].Requested:return c["a"].Requested;case a["VerificationRequestPhase"].Ready:return this._accepting?c["a"].Requested:c["a"].Ready;case a["VerificationRequestPhase"].Transitioned:if(!this._verifier)throw new Error("VerificationRequest: inner phase == Transitioned but no verifier!");return this._verifier.verificationPhase;case a["VerificationRequestPhase"].Done:return c["a"].Done;case a["VerificationRequestPhase"].Cancelled:return c["a"].Cancelled}throw new Error("Unknown verification phase ".concat(e))}get pending(){if(this.inner.isPassive())return!1;var e=this.phase;return e!==c["a"].Done&&e!==c["a"].Cancelled}get accepting(){return this._accepting}get declining(){return this._cancelling}get timeout(){return this.inner.timeRemainingMillis()}get methods(){throw new Error("not implemented")}get chosenMethod(){if(this.phase!==c["a"].Started)return null;var e=this.inner.getVerification();return e instanceof a["Sas"]?y["a"].Sas:e instanceof a["Qr"]?y["a"].Reciprocate:null}otherPartySupportsMethod(e){var t=this.inner.theirSupportedMethods;if(void 0===t)return!1;var r=m[e];return t.some(e=>e===r)}accept(){var e=this;return n()((function*(){if(e.inner.phase()!==a["VerificationRequestPhase"].Requested||e._accepting)throw new Error("Cannot accept a verification request in phase ".concat(e.phase));e._accepting=!0;try{var t=e.inner.acceptWithMethods(e.supportedVerificationMethods.map(b));t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))}finally{e._accepting=!1}e.emit(c["b"].Change)}))()}cancel(e){var t=this;return n()((function*(){if(!t._cancelling){t._cancelling=!0;try{var e=t.inner.cancel();e&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(e))}finally{t._cancelling=!1}}}))()}beginKeyVerification(e,t){throw new Error("not implemented")}startVerification(e){var t=this;return n()((function*(){if(e!==y["a"].Sas)throw new Error("Unsupported verification method ".concat(e));if(!(yield t.getOtherDevice()))throw new Error("startVerification(): other device is unknown");var r=yield t.inner.startSas();if(r){var[,i]=r;yield t.outgoingRequestProcessor.makeOutgoingRequest(i)}if(!t._verifier)throw new Error("Still no verifier after startSas() call");return t._verifier}))()}scanQRCode(e){var t=this;return n()((function*(){var r=a["QrCodeScan"].fromBytes(new Uint8ClampedArray(e)),i=yield t.inner.scanQrCode(r);if(!t._verifier)throw new Error("Still no verifier after scanQrCode() call");var n=i.reciprocate();return n&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(n)),t._verifier}))()}get verifier(){return this.phase===c["a"].Started?this._verifier:void 0}getQRCodeBytes(){throw new Error("getQRCodeBytes() unsupported in Rust Crypto; use generateQRCode() instead.")}generateQRCode(){var t=this;return n()((function*(){if(!(yield t.getOtherDevice()))throw new Error("generateQRCode(): other device is unknown");var r=yield t.inner.generateQrCode();if(r)return e.from(r.toBytes())}))()}get cancellationCode(){var e,t;return null!==(e=null===(t=this.inner.cancelInfo)||void 0===t?void 0:t.cancelCode())&&void 0!==e?e:null}get cancellingUserId(){var e=this.inner.cancelInfo;return e?e.cancelledbyUs()?this.olmMachine.userId.toString():this.inner.otherUserId.toString():void 0}}class p extends u["b"]{constructor(e,t){super(),this.inner=e,this.outgoingRequestProcessor=t,s()(this,"completionDeferred",void 0),this.completionDeferred=Object(g["i"])();var r=new WeakRef(this);e.registerChangesCallback(n()((function*(){var e;return null===(e=r.deref())||void 0===e?void 0:e.onChange()}))),this.completionDeferred.promise.catch(()=>null)}onChange(){if(this.inner.isDone())this.completionDeferred.resolve(void 0);else if(this.inner.isCancelled()){var e=this.inner.cancelInfo();this.completionDeferred.reject(new Error("Verification cancelled by ".concat(e.cancelledbyUs()?"us":"them"," with code ").concat(e.cancelCode(),": ").concat(e.reason())))}this.emit(c["b"].Change)}get hasBeenCancelled(){return this.inner.isCancelled()}get userId(){return this.inner.otherUserId.toString()}cancel(e){var t=this.inner.cancel();t&&this.outgoingRequestProcessor.makeOutgoingRequest(t)}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}class v extends p{constructor(e,t){super(e,t),s()(this,"callbacks",null)}onChange(){null===this.callbacks&&this.inner.hasBeenScanned()&&(this.callbacks={confirm:()=>{this.confirmScanning()},cancel:()=>this.cancel()}),super.onChange()}verify(){var e=this;return n()((function*(){null!==e.callbacks&&e.emit(c["c"].ShowReciprocateQr,e.callbacks),yield e.completionDeferred.promise}))()}get verificationPhase(){switch(this.inner.state()){case a["QrState"].Created:return c["a"].Ready;case a["QrState"].Scanned:return c["a"].Started;case a["QrState"].Confirmed:return c["a"].Started;case a["QrState"].Reciprocated:return c["a"].Started;case a["QrState"].Done:return c["a"].Done;case a["QrState"].Cancelled:return c["a"].Cancelled;default:throw new Error("Unknown qr code state ".concat(this.inner.state()))}}getReciprocateQrCodeCallbacks(){return this.callbacks}confirmScanning(){var e=this;return n()((function*(){var t=e.inner.confirmScanning();t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))}))()}}class f extends p{constructor(e,t,r){super(e,r),s()(this,"callbacks",null)}verify(){var e=this;return n()((function*(){yield e.sendAccept(),yield e.completionDeferred.promise}))()}sendAccept(){var e=this;return n()((function*(){var t=e.inner.accept();t&&(yield e.outgoingRequestProcessor.makeOutgoingRequest(t))}))()}onChange(){var e=this;if(super.onChange(),null===this.callbacks){var t=this.inner.emoji(),r=this.inner.decimals();if(void 0===t&&void 0===r)return;var i={};t&&(i.emoji=t.map(e=>[e.symbol,e.description])),r&&(i.decimal=[r[0],r[1],r[2]]),this.callbacks={sas:i,confirm:function(){var t=n()((function*(){var t=yield e.inner.confirm();for(var r of t)yield e.outgoingRequestProcessor.makeOutgoingRequest(r)}));function r(){return t.apply(this,arguments)}return r}(),mismatch:()=>{var e=this.inner.cancelWithCode("m.mismatched_sas");e&&this.outgoingRequestProcessor.makeOutgoingRequest(e)},cancel:()=>{var e=this.inner.cancelWithCode("m.user");e&&this.outgoingRequestProcessor.makeOutgoingRequest(e)}},this.emit(c["c"].ShowSas,this.callbacks)}}get verificationPhase(){return c["a"].Started}getShowSasCallbacks(){return this.callbacks}replaceInner(e){if(this.inner!=e){this.inner=e;var t=new WeakRef(this);e.registerChangesCallback(n()((function*(){var e;return null===(e=t.deref())||void 0===e?void 0:e.onChange()}))),this.sendAccept(),this.onChange()}}}var m={[y["a"].Sas]:a["VerificationMethod"].SasV1,[y["a"].ScanQrCode]:a["VerificationMethod"].QrCodeScanV1,[y["a"].ShowQrCode]:a["VerificationMethod"].QrCodeShowV1,[y["a"].Reciprocate]:a["VerificationMethod"].ReciprocateV1};function b(e){var t=m[e];if(void 0===t)throw new Error("Unknown verification method ".concat(e));return t}function k(e){switch(e.getType()){case l["b"].KeyVerificationCancel:case l["b"].KeyVerificationDone:case l["b"].KeyVerificationMac:case l["b"].KeyVerificationStart:case l["b"].KeyVerificationKey:case l["b"].KeyVerificationReady:case l["b"].KeyVerificationAccept:return!0;case l["b"].RoomMessage:return e.getContent().msgtype===l["e"].KeyVerificationRequest;default:return!1}}}).call(this,r("b639").Buffer)},c2ab:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));r("d9e2");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("67b8");class c{constructor(e,t,r){this.logger=e,this.olmMachine=t,this.outgoingRequestProcessor=r,s()(this,"stopped",!1),s()(this,"outgoingRequestLoopRunning",!1),s()(this,"nextLoopDeferred",void 0)}stop(){this.stopped=!0}doProcessOutgoingRequests(){this.nextLoopDeferred||(this.nextLoopDeferred=Object(a["i"])());var e=this.nextLoopDeferred.promise;return this.outgoingRequestLoopRunning||this.outgoingRequestLoop().catch(e=>{this.logger.error("Uncaught error in outgoing request loop",e)}),e}outgoingRequestLoop(){var e=this;return n()((function*(){if(e.outgoingRequestLoopRunning)throw new Error("Cannot run two outgoing request loops");e.outgoingRequestLoopRunning=!0;try{while(!e.stopped&&e.nextLoopDeferred){var t=e.nextLoopDeferred;e.nextLoopDeferred=void 0,yield e.processOutgoingRequests().then(t.resolve,t.reject)}}finally{e.outgoingRequestLoopRunning=!1}e.nextLoopDeferred&&e.nextLoopDeferred.reject(new Error("OutgoingRequestsManager was stopped"))}))()}processOutgoingRequests(){var e=this;return n()((function*(){if(!e.stopped){var t=yield e.olmMachine.outgoingRequests(),r=function*(t){if(e.stopped)return{v:void 0};try{yield Object(a["u"])(e.logger,"Make outgoing request ".concat(t.type),n()((function*(){yield e.outgoingRequestProcessor.makeOutgoingRequest(t)})))}catch(r){e.logger.error("Failed to process outgoing request ".concat(t.type,": ").concat(r))}};for(var i of t){var o=yield*r(i);if("object"===typeof o)return o.v}}}))()}}},e3ab:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var i=r("fbe9"),n=r.n(i),o=r("0036");class s{constructor(e,t,r){this.olmMachine=e,this.outgoingRequestProcessor=t,this.secretStorage=r}bootstrapCrossSigning(e){var t=this;return n()((function*(){if(e.setupNewCrossSigning)yield t.resetCrossSigning(e.authUploadDeviceSigningKeys);else{var r=yield t.olmMachine.crossSigningStatus(),i=yield t.secretStorage.get("m.cross_signing.master"),n=yield t.secretStorage.get("m.cross_signing.self_signing"),s=yield t.secretStorage.get("m.cross_signing.user_signing"),a=Boolean(i&&n&&s),c=r.hasMaster&&r.hasUserSigning&&r.hasSelfSigning;if(o["b"].log("bootstrapCrossSigning: starting",{setupNewCrossSigning:e.setupNewCrossSigning,olmDeviceHasMaster:r.hasMaster,olmDeviceHasUserSigning:r.hasUserSigning,olmDeviceHasSelfSigning:r.hasSelfSigning,privateKeysInSecretStorage:a}),c)(yield t.secretStorage.hasKey())?a?o["b"].log("bootstrapCrossSigning: Olm device has private keys and they are saved in secret storage; doing nothing"):(o["b"].log("bootstrapCrossSigning: Olm device has private keys: exporting to secret storage"),yield t.exportCrossSigningKeysToStorage()):o["b"].warn("bootstrapCrossSigning: Olm device has private keys, but secret storage is not yet set up; doing nothing for now.");else if(a){o["b"].log("bootstrapCrossSigning: Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),yield t.olmMachine.importCrossSigningKeys(i,n,s);var u=yield t.olmMachine.getDevice(t.olmMachine.userId,t.olmMachine.deviceId);try{var d=yield u.verify();yield t.outgoingRequestProcessor.makeOutgoingRequest(d)}finally{u.free()}}else o["b"].log("bootstrapCrossSigning: Cross-signing private keys not found locally or in secret storage, creating new keys"),yield t.resetCrossSigning(e.authUploadDeviceSigningKeys);o["b"].log("bootstrapCrossSigning: complete")}}))()}resetCrossSigning(e){var t=this;return n()((function*(){var r=yield t.olmMachine.bootstrapCrossSigning(!0);for(var i of((yield t.secretStorage.hasKey())?(o["b"].log("resetCrossSigning: exporting to secret storage"),yield t.exportCrossSigningKeysToStorage()):o["b"].warn("resetCrossSigning: Secret storage is not yet set up; not exporting keys to secret storage yet."),o["b"].log("resetCrossSigning: publishing keys to server"),[r.uploadKeysRequest,r.uploadSigningKeysRequest,r.uploadSignaturesRequest]))i&&(yield t.outgoingRequestProcessor.makeOutgoingRequest(i,e))}))()}exportCrossSigningKeysToStorage(){var e=this;return n()((function*(){var t=yield e.olmMachine.exportCrossSigningKeys();null!==t&&void 0!==t&&t.masterKey?yield e.secretStorage.store("m.cross_signing.master",t.masterKey):o["b"].error("Cannot export MSK to secret storage, private key unknown"),null!==t&&void 0!==t&&t.self_signing_key?yield e.secretStorage.store("m.cross_signing.self_signing",t.self_signing_key):o["b"].error("Cannot export SSK to secret storage, private key unknown"),null!==t&&void 0!==t&&t.userSigningKey?yield e.secretStorage.store("m.cross_signing.user_signing",t.userSigningKey):o["b"].error("Cannot export USK to secret storage, private key unknown")}))()}}},e98d:function(e,t,r){"use strict";r.d(t,"b",(function(){return o})),r.d(t,"a",(function(){return a}));var i=r("fbe9"),n=r.n(i);function o(e){return s.apply(this,arguments)}function s(){return s=n()((function*(e){return a(e,["m.cross_signing.master","m.cross_signing.user_signing","m.cross_signing.self_signing"])})),s.apply(this,arguments)}function a(e,t){return c.apply(this,arguments)}function c(){return c=n()((function*(e,t){var r=yield e.getDefaultKeyId();if(!r)return!1;for(var i of t){var n=(yield e.isStored(i))||{};if(!(r in n))return!1}return!0})),c.apply(this,arguments)}},eb1f:function(e,t,r){"use strict";r.d(t,"b",(function(){return l})),r.d(t,"a",(function(){return h}));r("2c66"),r("249d"),r("40e9"),r("907a"),r("986a"),r("1d02"),r("3c5d"),r("6ce5"),r("2834"),r("4ea1");var i=r("fbe9"),n=r.n(i),o=r("054a"),s=r.n(o),a=r("700b"),c=r("67b8"),u=r("be2e"),d=r("ac66"),l="/_matrix/client/unstable/org.matrix.msc3814.v1",g="org.matrix.msc3814",y=6048e5;class h{constructor(e,t,r,i,n){this.logger=e,this.olmMachine=t,this.http=r,this.outgoingRequestProcessor=i,this.secretStorage=n,s()(this,"key",void 0),s()(this,"intervalId",void 0)}isSupported(){var e=this;return n()((function*(){try{yield e.http.authedRequest(u["i"].Get,"/dehydrated_device",void 0,void 0,{prefix:l})}catch(r){var t=r;if("M_UNRECOGNIZED"===t.errcode)return!1;if("M_NOT_FOUND"===t.errcode)return!0;throw r}return!0}))()}start(e){var t=this;return n()((function*(){t.stop();try{yield t.rehydrateDeviceIfAvailable()}catch(r){t.logger.info("dehydration: Error rehydrating device:",r)}e&&(yield t.resetKey()),yield t.scheduleDeviceDehydration()}))()}isKeyStored(){var e=this;return n()((function*(){return Boolean(yield e.secretStorage.isStored(g))}))()}resetKey(){var e=this;return n()((function*(){var t=new Uint8Array(32);globalThis.crypto.getRandomValues(t),yield e.secretStorage.store(g,Object(d["c"])(t)),e.key=t}))()}getKey(e){var t=this;return n()((function*(){if(void 0===t.key){var r=yield t.secretStorage.get(g);if(void 0===r){if(!e)return null;yield t.resetKey()}else t.key=Object(d["a"])(r)}return t.key}))()}rehydrateDeviceIfAvailable(){var e=this;return n()((function*(){var t,r=yield e.getKey(!1);if(!r)return!1;try{t=yield e.http.authedRequest(u["i"].Get,"/dehydrated_device",void 0,void 0,{prefix:l})}catch(p){var i=p;if("M_NOT_FOUND"===i.errcode||"M_UNRECOGNIZED"===i.errcode)return e.logger.info("dehydration: No dehydrated device"),!1;throw i}e.logger.info("dehydration: dehydrated device found");var n=yield e.olmMachine.dehydratedDevices().rehydrate(r,new a["DeviceId"](t.device_id),JSON.stringify(t.device_data));e.logger.info("dehydration: device rehydrated");var o=void 0,s=0,d=0,g=Object(c["k"])("/dehydrated_device/$device_id/events",{$device_id:t.device_id});while(1){var y=yield e.http.authedRequest(u["i"].Post,g,void 0,o?{next_batch:o}:{},{prefix:l});if(0===y.events.length)break;s+=y.events.length,o=y.next_batch;var h=yield n.receiveEvents(JSON.stringify(y.events));d+=h.length}return e.logger.info("dehydration: received ".concat(d," room keys from ").concat(s," to-device events")),!0}))()}createAndUploadDehydratedDevice(){var e=this;return n()((function*(){var t=yield e.getKey(!0),r=yield e.olmMachine.dehydratedDevices().create(),i=yield r.keysForUpload("Dehydrated device",t);yield e.outgoingRequestProcessor.makeOutgoingRequest(i),e.logger.info("dehydration: uploaded device")}))()}scheduleDeviceDehydration(){var e=this;return n()((function*(){e.stop(),yield e.createAndUploadDehydratedDevice(),e.intervalId=setInterval(()=>{e.createAndUploadDehydratedDevice().catch(t=>{e.logger.error("Error creating dehydrated device:",t)})},y)}))()}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0)}}}}]);
//# sourceMappingURL=matrix-element.16.min.js.map