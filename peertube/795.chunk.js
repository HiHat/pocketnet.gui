/*! For license information please see 795.chunk.js.LICENSE.txt */
(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[795],{3819:(e,t,n)=>{"use strict";var r;n.d(t,{zW:()=>r,ou:()=>Pe}),function(e){e.SegmentLoaded="segment_loaded",e.SegmentError="segment_error",e.SegmentSize="segment_size",e.SegmentAbort="segment_abort",e.SegmentStartLoad="segment_start_load",e.PeerConnect="peer_connect",e.PeerClose="peer_close",e.PieceBytesDownloaded="piece_bytes_downloaded",e.PieceBytesUploaded="piece_bytes_uploaded"}(r||(r={}));var s=n(649),o=n(7201),i=n.n(o),a=n(5101),l=n(4487),d=n.n(l);n(9739);function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=S(e);if(t){var s=S(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return p(this,n)}}function p(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=y(e,t);if(r){var s=Object.getOwnPropertyDescriptor(r,t);return s.get?s.get.call(arguments.length<3?e:n):s.value}},h.apply(this,arguments)}function y(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}let w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(o,e);var t,n,r,s=m(o);function o(){var e,t,n;return g(this,o),(n=s.apply(this,arguments)).on=(t,r)=>h((e=f(n),S(o.prototype)),"on",e).call(e,t,r),n.emit=function(e){for(var r,s=arguments.length,i=new Array(s>1?s-1:0),a=1;a<s;a++)i[a-1]=arguments[a];return(r=h((t=f(n),S(o.prototype)),"emit",t)).call.apply(r,[t,e].concat(i))},n}return t=o,n&&u(t.prototype,n),r&&u(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(a.EventEmitter);function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&M(e,t)}function M(e,t){return M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},M(e,t)}function I(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=q(e);if(t){var s=q(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return T(this,n)}}function T(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return O(e)}function O(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function q(e){return q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},q(e)}let C=function(e){R(n,e);var t=I(n);function n(e){var r;return P(this,n),(r=t.call(this)).settings=e,r.fetchRequests=new Map,r.failedSegments=new Map,r.debug=i()("p2pml:http-media-manager"),r.fetch=function(){return fetch.apply(void 0,arguments)},r.download=(e,t)=>{if(r.isDownloading(e))return;console.log("download"),r.cleanTimedOutFailedSegments(),r.emit("segment-start-load",e);const n=r.buildSegmentUrl(e),s=new AbortController;r.fetchRequests.set(e.id,{fetchAbort:s,segment:e,initialPriority:e.priority,segmentUrl:n}),r.debug("http segment download",n),e.requestUrl=n;const o=new Headers;if(e.range)o.append("Range",e.range);else if(void 0!==t&&r.settings.httpUseRanges){let e=0;for(const n of t)e+=n.byteLength;o.append("Range",`bytes=${e}-`),r.debug("continue download from",e)}else t=void 0;const i=s.signal,a=r.fetch(n,{headers:o,signal:i});r.setupFetchEvents(a,e,t).catch((t=>{if("AbortError"!==t.name)if("network error"!==t.message)if("Failed to fetch"!==t.message);else{r.debug("Segment fetch failed",e);const t=Error("FETCH_FAILED");r.segmentFailure(e,t,e.url)}else{r.debug("Segment loading is unavailable. No internet",e);const t=Error("NETWORK_ERROR");r.segmentFailure(e,t,e.url)}else r.debug("Segment loading was aborted by user",e)})),r.fetchRequests.set(e.id,{request:a,fetchAbort:s,segment:e,initialPriority:e.priority,segmentUrl:n})},r.updatePriority=e=>{const t=r.fetchRequests.get(e.id);if(!t)throw new Error("Cannot update priority of not downloaded segment "+e.id);e.priority<=r.settings.requiredSegmentsPriority&&t.initialPriority>r.settings.requiredSegmentsPriority&&t.segmentUrl!==r.buildSegmentUrl(e)&&(r.debug("aborting http segment abort because the segment is now in a high priority",e.id),r.abort(e),r.download(e))},r.abort=e=>{const t=r.fetchRequests.get(e.id);console.log("abort command"),t&&(console.log("ABORT"),t.fetchAbort.abort(),r.fetchRequests.delete(e.id),r.debug("http segment abort",e.id))},r.isDownloading=e=>r.fetchRequests.has(e.id),r.isFailed=e=>{const t=r.failedSegments.get(e.id);return void 0!==t&&t>r.now()},r.getActiveDownloads=()=>r.fetchRequests,r.getActiveDownloadsCount=()=>r.fetchRequests.size,r.destroy=()=>{r.fetchRequests.forEach((e=>e.fetchAbort.abort())),r.fetchRequests.clear()},r.setupFetchEvents=(e,t,n)=>(0,s.mG)(O(r),void 0,void 0,(function*(){const r=yield e,s=r.body.getReader(),o=r.headers.get("Content-Length"),i=Number.parseFloat(o),a=new Uint8Array(i);let l,d=0;if(Array.isArray(n)&&206===r.status)for(const e of n){const t=new Uint8Array(e);a.set(t,d),d=e.byteLength}for(;!(l=yield s.read()).done;){const e=l.value;a.set(e,d),d+=e.length,this.emit("bytes-downloaded",t,e.length),i&&this.emit("segment-size",t,i)}if(r.status<200||r.status>=300){const e=Error(`Segment failure with HTTP code ${r.status}`);this.segmentFailure(t,e,r.url)}else yield this.segmentDownloadFinished(t,a.buffer,r)})),r.segmentDownloadFinished=(e,t,n)=>(0,s.mG)(O(r),void 0,void 0,(function*(){if(e.responseUrl=n.url,this.settings.segmentValidator)try{yield this.settings.segmentValidator(Object.assign(Object.assign({},e),{data:t}),"http")}catch(t){return this.debug("segment validator failed",t),void this.segmentFailure(e,t,n.url)}this.fetchRequests.delete(e.id),this.emit("segment-loaded",e,t)})),r.segmentFailure=(e,t,n)=>{e.responseUrl=n,r.fetchRequests.delete(e.id),r.failedSegments.set(e.id,r.now()+r.settings.httpFailedSegmentTimeout),r.emit("segment-error",e,t)},r.cleanTimedOutFailedSegments=()=>{const e=r.now(),t=[];r.failedSegments.forEach(((n,r)=>{n<e&&t.push(r)})),t.forEach((e=>r.failedSegments.delete(e)))},r.now=()=>performance.now(),e.localTransport&&(r.fetch=e.localTransport),r}return v(n,[{key:"buildSegmentUrl",value:function(e){return this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(e):e.url}}]),n}(function(e){R(n,e);var t=I(n);function n(){return P(this,n),t.apply(this,arguments)}return v(n)}(w));var D,k,E=n(3101),j=n.n(E),A=n(8823),B=n(6029),_=n.n(B);function L(e,t){return L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},L(e,t)}function U(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Q(e);if(t){var s=Q(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return x(this,n)}}function x(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return z(e)}function z(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Q(e){return Q=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Q(e)}function G(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function H(e,t,n){return t&&G(e.prototype,t),n&&G(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){e[e.SegmentData=0]="SegmentData",e[e.SegmentAbsent=1]="SegmentAbsent",e[e.SegmentsMap=2]="SegmentsMap",e[e.SegmentRequest=3]="SegmentRequest",e[e.CancelSegmentRequest=4]="CancelSegmentRequest"}(D||(D={})),function(e){e[e.Loaded=0]="Loaded",e[e.LoadingByHttp=1]="LoadingByHttp"}(k||(k={}));let W=H((function e(t,n){F(this,e),this.id=t,this.size=n,this.bytesDownloaded=0,this.pieces=[]})),$=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&L(e,t)}(n,e);var t=U(n);function n(e,r){var s;return F(this,n),(s=t.call(this)).peer=e,s.settings=r,s.remoteAddress="",s.downloadingSegmentId=null,s.downloadingSegment=null,s.segmentsMap=new Map,s.debug=i()("p2pml:media-peer"),s.timer=null,s.onPeerConnect=()=>{s.debug("peer connect",s.id,z(s)),s.remoteAddress=s.peer.remoteAddress,s.emit("connect",z(s))},s.onPeerClose=()=>{s.debug("peer close",s.id,z(s)),s.terminateSegmentRequest(),s.emit("close",z(s))},s.onPeerError=e=>{s.debug("peer error",s.id,e,z(s))},s.receiveSegmentPiece=e=>{if(!s.downloadingSegment)return void s.debug("peer segment not requested",s.id,z(s));s.downloadingSegment.bytesDownloaded+=e.byteLength,s.downloadingSegment.pieces.push(e);const t=s.downloadingSegment.id;if(s.emit("bytes-downloaded",z(s),t,e.byteLength),s.downloadingSegment.bytesDownloaded===s.downloadingSegment.size){const e=new Uint8Array(s.downloadingSegment.size);let n=0;for(const t of s.downloadingSegment.pieces)e.set(new Uint8Array(t),n),n+=t.byteLength;s.debug("peer segment download done",s.id,t,z(s)),s.terminateSegmentRequest(),s.emit("segment-loaded",z(s),t,e.buffer)}else s.downloadingSegment.bytesDownloaded>s.downloadingSegment.size&&(s.debug("peer segment download bytes mismatch",s.id,t,z(s)),s.terminateSegmentRequest(),s.emit("segment-error",z(s),t,"Too many bytes received for segment"))},s.getJsonCommand=e=>{const t=new Uint8Array(e);if(123===t[0]&&34===t[1]&&125===t[e.byteLength-1])try{return JSON.parse((new TextDecoder).decode(e))}catch(e){return null}return null},s.onPeerData=e=>{const t=s.getJsonCommand(e);if(null!==t){if(s.downloadingSegment){s.debug("peer segment download is interrupted by a command",s.id,z(s));const e=s.downloadingSegment.id;return s.terminateSegmentRequest(),void s.emit("segment-error",z(s),e,"Segment download is interrupted by a command")}switch(s.debug("peer receive command",s.id,t,z(s)),t.c){case D.SegmentsMap:s.segmentsMap=s.createSegmentsMap(t.m),s.emit("data-updated");break;case D.SegmentRequest:s.emit("segment-request",z(s),t.i);break;case D.SegmentData:s.downloadingSegmentId&&s.downloadingSegmentId===t.i&&"number"==typeof t.s&&t.s>=0&&(s.downloadingSegment=new W(t.i,t.s),s.emit("segment-start-load",s.downloadingSegment.id),s.emit("segment-size",s.downloadingSegment.id,s.downloadingSegment.size),s.cancelResponseTimeoutTimer());break;case D.SegmentAbsent:s.downloadingSegmentId&&s.downloadingSegmentId===t.i&&(s.terminateSegmentRequest(),s.segmentsMap.delete(t.i),s.emit("segment-absent",z(s),t.i));case D.CancelSegmentRequest:}}else s.receiveSegmentPiece(e)},s.createSegmentsMap=e=>{if(!(e instanceof Object))return new Map;const t=new Map;for(const n of Object.keys(e)){const r=e[n];if(!(r instanceof Array&&2===r.length&&"string"==typeof r[0]&&r[1]instanceof Array))return new Map;const s=r[0].split("|"),o=r[1];if(s.length!==o.length)return new Map;for(let e=0;e<s.length;e++){const r=o[e];if("number"!=typeof r||void 0===k[r])return new Map;t.set(`${n}+${s[e]}`,r)}}return t},s.sendCommand=e=>{s.debug("peer send command",s.id,e,z(s)),s.peer.write(JSON.stringify(e))},s.destroy=()=>{s.debug("peer destroy",s.id,z(s)),s.terminateSegmentRequest(),s.peer.destroy()},s.getDownloadingSegmentId=()=>s.downloadingSegmentId,s.getSegmentsMap=()=>s.segmentsMap,s.sendSegmentsMap=e=>{s.sendCommand({c:D.SegmentsMap,m:e})},s.sendSegmentData=(e,t)=>{s.sendCommand({c:D.SegmentData,i:e,s:t.byteLength});let n=t.byteLength;for(;n>0;){const e=n>=s.settings.webRtcMaxMessageSize?s.settings.webRtcMaxMessageSize:n,r=A.Buffer.from(t,t.byteLength-n,e);s.peer.write(r),n-=e}s.emit("bytes-uploaded",z(s),e,t.byteLength)},s.sendSegmentAbsent=e=>{s.sendCommand({c:D.SegmentAbsent,i:e})},s.requestSegment=e=>{if(s.downloadingSegmentId)throw new Error("A segment is already downloading: "+s.downloadingSegmentId);s.sendCommand({c:D.SegmentRequest,i:e}),s.downloadingSegmentId=e,s.runResponseTimeoutTimer()},s.cancelSegmentRequest=()=>{let e;if(s.downloadingSegmentId){const t=s.downloadingSegmentId;e=s.downloadingSegment?s.downloadingSegment.pieces:void 0,s.terminateSegmentRequest(),s.sendCommand({c:D.CancelSegmentRequest,i:t})}return e},s.runResponseTimeoutTimer=()=>{s.timer=setTimeout((()=>{if(s.timer=null,!s.downloadingSegmentId)return;const e=s.downloadingSegmentId;s.cancelSegmentRequest(),s.emit("segment-timeout",z(s),e)}),s.settings.p2pSegmentDownloadTimeout)},s.cancelResponseTimeoutTimer=()=>{s.timer&&(clearTimeout(s.timer),s.timer=null)},s.terminateSegmentRequest=()=>{s.downloadingSegmentId=null,s.downloadingSegment=null,s.cancelResponseTimeoutTimer()},s.peer.on("connect",s.onPeerConnect),s.peer.on("close",s.onPeerClose),s.peer.on("error",s.onPeerError),s.peer.on("data",s.onPeerData),s.id=e.id,s}return H(n)}(w);function J(e,t){return J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},J(e,t)}function V(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=X(e);if(t){var s=X(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return N(this,n)}}function N(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return K(e)}function K(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function X(e){return X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},X(e)}function Y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e,t,n){return t&&Y(e.prototype,t),n&&Y(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}const te=`-WW${"0.6.2".replace(/\d*./g,(e=>("0"+parseInt(e,10)%100).slice(-2))).slice(0,4)}-`;let ne=Z((function e(t,n){ee(this,e),this.peerId=t,this.segment=n}));let re=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&J(e,t)}(n,e);var t=V(n);function n(e,r){var o;return ee(this,n),(o=t.call(this)).segmentsStorage=e,o.settings=r,o.trackerClient=null,o.peers=new Map,o.peerCandidates=new Map,o.peerSegmentRequests=new Map,o.streamSwarmId=null,o.debug=i()("p2pml:p2p-media-manager"),o.pendingTrackerClient=null,o.getPeers=()=>o.peers,o.getPeerId=()=>A.Buffer.from(o.peerId).toString("hex"),o.setStreamSwarmId=(e,t)=>{if(o.streamSwarmId===e)return;o.destroy(!0),o.streamSwarmId=e,o.masterSwarmId=t,o.debug("stream swarm ID",o.streamSwarmId),o.pendingTrackerClient={isDestroyed:!1};const n=o.pendingTrackerClient,r=(new(_())).update(`2${o.streamSwarmId}`).digest();n.isDestroyed?null!==o.trackerClient&&(o.trackerClient.destroy(),o.trackerClient=null):(o.pendingTrackerClient=null,o.createClient(r))},o.createClient=e=>{if(!o.settings.useP2P)return;const t={infoHash:A.Buffer.from(e,0,20),peerId:A.Buffer.from(o.peerId,0,20),announce:o.settings.trackerAnnounce,rtcConfig:o.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:o.settings.peerRequestsPerAnnounce})};let n=o.trackerClient;o.trackerClient=new(j())(t),o.trackerClient.on("error",o.onTrackerError),o.trackerClient.on("warning",o.onTrackerWarning),o.trackerClient.on("update",o.onTrackerUpdate),o.trackerClient.on("peer",o.onTrackerPeer),o.trackerClient.start(),null!==n&&(n.destroy(),n=null)},o.onTrackerError=e=>{o.debug("tracker error",e)},o.onTrackerWarning=e=>{o.debug("tracker warning",e)},o.onTrackerUpdate=e=>{o.debug("tracker update",e),o.emit("tracker-update",e)},o.onTrackerPeer=e=>{if(o.debug("tracker peer",e.id,e),o.peers.has(e.id))return o.debug("tracker peer already connected",e.id,e),void e.destroy();const t=new $(e,o.settings);t.on("connect",o.onPeerConnect),t.on("close",o.onPeerClose),t.on("data-updated",o.onPeerDataUpdated),t.on("segment-request",o.onSegmentRequest),t.on("segment-loaded",o.onSegmentLoaded),t.on("segment-absent",o.onSegmentAbsent),t.on("segment-error",o.onSegmentError),t.on("segment-size",o.onSegmentSize),t.on("segment-start-load",o.onSegmentStartLoad),t.on("segment-timeout",o.onSegmentTimeout),t.on("bytes-downloaded",o.onPieceBytesDownloaded),t.on("bytes-uploaded",o.onPieceBytesUploaded);let n=o.peerCandidates.get(t.id);n||(n=[],o.peerCandidates.set(t.id,n)),n.push(t)},o.download=e=>{if(o.isDownloading(e))return!1;const t=[];for(const n of o.peers.values())null===n.getDownloadingSegmentId()&&n.getSegmentsMap().get(e.id)===k.Loaded&&t.push(n);if(0===t.length)return!1;const n=t[Math.floor(Math.random()*t.length)];return n.requestSegment(e.id),o.peerSegmentRequests.set(e.id,new ne(n.id,e)),!0},o.abort=e=>{let t;const n=o.peerSegmentRequests.get(e.id);if(n){const r=o.peers.get(n.peerId);r&&(t=r.cancelSegmentRequest()),o.peerSegmentRequests.delete(e.id)}return t},o.isDownloading=e=>o.peerSegmentRequests.has(e.id),o.getActiveDownloadsCount=()=>o.peerSegmentRequests.size,o.destroy=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];o.streamSwarmId=null,o.trackerClient&&(o.trackerClient.stop(),e?(o.trackerClient.removeAllListeners("error"),o.trackerClient.removeAllListeners("warning"),o.trackerClient.removeAllListeners("update"),o.trackerClient.removeAllListeners("peer")):(o.trackerClient.destroy(),o.trackerClient=null)),o.pendingTrackerClient&&(o.pendingTrackerClient.isDestroyed=!0,o.pendingTrackerClient=null),o.peers.forEach((e=>e.destroy())),o.peers.clear(),o.peerSegmentRequests.clear();for(const e of o.peerCandidates.values())for(const t of e)t.destroy();o.peerCandidates.clear()},o.sendSegmentsMapToAll=e=>{o.peers.forEach((t=>t.sendSegmentsMap(e)))},o.sendSegmentsMap=(e,t)=>{const n=o.peers.get(e);n&&n.sendSegmentsMap(t)},o.getOverallSegmentsMap=()=>{const e=new Map;for(const t of o.peers.values())for(const[n,r]of t.getSegmentsMap())r===k.Loaded?e.set(n,k.Loaded):e.get(n)||e.set(n,k.LoadingByHttp);return e},o.onPieceBytesDownloaded=(e,t,n)=>{const r=o.peerSegmentRequests.get(t);r&&o.emit("bytes-downloaded",r.segment,n,e.id)},o.onPieceBytesUploaded=(e,t,n)=>{const r=o.peerSegmentRequests.get(t);o.emit("bytes-uploaded",r?r.segment:null,n,e.id)},o.onPeerConnect=e=>{if(o.peers.get(e.id))return o.debug("tracker peer already connected (in peer connect)",e.id,e),void e.destroy();o.peers.set(e.id,e);const t=o.peerCandidates.get(e.id);if(t){for(const n of t)n!==e&&n.destroy();o.peerCandidates.delete(e.id)}o.emit("peer-connected",{id:e.id,remoteAddress:e.remoteAddress})},o.onPeerClose=e=>{if(o.peers.get(e.id)!==e){const t=o.peerCandidates.get(e.id);if(!t)return;const n=t.indexOf(e);return-1!==n&&t.splice(n,1),void(0===t.length&&o.peerCandidates.delete(e.id))}for(const[t,n]of o.peerSegmentRequests)n.peerId===e.id&&o.peerSegmentRequests.delete(t);o.peers.delete(e.id),o.emit("peer-data-updated"),o.emit("peer-closed",e.id)},o.onPeerDataUpdated=()=>{o.emit("peer-data-updated")},o.onSegmentRequest=(e,t)=>(0,s.mG)(K(o),void 0,void 0,(function*(){if(void 0===this.masterSwarmId)return;const n=yield this.segmentsStorage.getSegment(t,this.masterSwarmId);n&&n.data?e.sendSegmentData(t,n.data):e.sendSegmentAbsent(t)})),o.onSegmentLoaded=(e,t,n)=>(0,s.mG)(K(o),void 0,void 0,(function*(){const r=this.peerSegmentRequests.get(t);if(!r)return;const s=r.segment;if(this.settings.segmentValidator)try{yield this.settings.segmentValidator(Object.assign(Object.assign({},s),{data:n}),"p2p",e.id)}catch(n){return this.debug("segment validator failed",n),this.peerSegmentRequests.delete(t),this.emit("segment-error",s,n,e.id),void this.onPeerClose(e)}this.peerSegmentRequests.delete(t),this.emit("segment-loaded",s,n,e.id)})),o.onSegmentAbsent=(e,t)=>{o.peerSegmentRequests.delete(t),o.emit("peer-data-updated")},o.onSegmentError=(e,t,n)=>{const r=o.peerSegmentRequests.get(t);r&&(o.peerSegmentRequests.delete(t),o.emit("segment-error",r.segment,n,e.id))},o.onSegmentSize=(e,t)=>{const n=o.peerSegmentRequests.get(e);n&&o.emit("segment-size",n.segment,t)},o.onSegmentStartLoad=(e,t)=>{const n=o.peerSegmentRequests.get(e);n&&o.emit("segment-start-load",n.segment,t)},o.onSegmentTimeout=(e,t)=>{const n=o.peerSegmentRequests.get(t);n&&(o.peerSegmentRequests.delete(t),e.destroy(),o.peers.delete(n.peerId)&&o.emit("peer-data-updated"))},o.peerId=r.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t=te;for(let n=0;n<20-te.length;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(t).buffer}():new ArrayBuffer(0),o.debug.enabled&&o.debug("peer ID",o.getPeerId(),(new TextDecoder).decode(o.peerId)),o}return Z(n)}(w);function se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function oe(e,t,n){return t&&se(e.prototype,t),n&&se(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ie(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}const ae=i()("p2pml:bandwidth-approximator"),le=2e3;let de=oe((function e(t,n){ie(this,e),this.value=t,this.timeStamp=n})),ue=oe((function e(){ie(this,e),this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(e,t)=>{for(ae("Add %d bytes.",e),this.lastBytes.push(new de(e,t)),this.currentBytesSum+=e;t-this.lastBytes[0].timeStamp>le;)this.currentBytesSum-=this.lastBytes.shift().value;const n=Math.min(le,t);this.lastBandwidth.push(new de(this.currentBytesSum/n,t))},this.getBandwidth=e=>{for(;0!==this.lastBandwidth.length&&e-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let t=0;for(const e of this.lastBandwidth)e.value>t&&(t=e.value);return ae("Max bandwidth: %d.",t),t},this.getSmoothInterval=()=>le,this.getMeasureInterval=()=>4e4}));function ge(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ce(e,t,n){return t&&ge(e.prototype,t),n&&ge(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}let me=ce((function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.settings=t,this.cache=new Map,this.storeSegment=e=>(0,s.mG)(this,void 0,void 0,(function*(){this.cache.set(e.id,{segment:e,lastAccessed:performance.now()})})),this.getSegmentsMap=()=>(0,s.mG)(this,void 0,void 0,(function*(){return this.cache})),this.getSegment=e=>(0,s.mG)(this,void 0,void 0,(function*(){const t=this.cache.get(e);if(void 0!==t)return t.lastAccessed=performance.now(),t.segment})),this.hasSegment=e=>(0,s.mG)(this,void 0,void 0,(function*(){return this.cache.has(e)})),this.clean=(e,t)=>(0,s.mG)(this,void 0,void 0,(function*(){const e=[],n=[],r=performance.now();for(const t of this.cache.values())r-t.lastAccessed>this.settings.cachedSegmentExpiration?e.push(t.segment.id):n.push(t);let s=n.length-this.settings.cachedSegmentsCount;if(s>0){n.sort(((e,t)=>e.lastAccessed-t.lastAccessed));for(const r of n)if((void 0===t||!t(r.segment.id))&&(e.push(r.segment.id),s--,0===s))break}return e.forEach((e=>this.cache.delete(e))),e.length>0})),this.destroy=()=>(0,s.mG)(this,void 0,void 0,(function*(){this.cache.clear()}))}));function pe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t){return he=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},he(e,t)}function ye(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=be(e);if(t){var s=be(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return Se(this,n)}}function Se(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return we(e)}function we(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function be(e){return be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},be(e)}const ve={cachedSegmentExpiration:6e5,cachedSegmentsCount:1e3,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:3,simultaneousHttpDownloads:2,httpDownloadProbability:.06,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1500,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:100,httpUseRanges:!1,simultaneousP2PDownloads:20,p2pDownloadMaxPriority:50,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:d().config};let Pe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&he(e,t)}(l,e);var t,n,o,a=ye(l);function l(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};fe(this,l),(e=a.call(this)).debug=i()("p2pml:hybrid-loader"),e.debugSegments=i()("p2pml:hybrid-loader-segments"),e.segmentsQueue=[],e.bandwidthApproximator=new ue,e.httpDownloadInitialTimeoutTimestamp=-1/0,e.createHttpManager=()=>new C(e.settings),e.createP2PManager=()=>new re(e.segmentsStorage,e.settings),e.load=(t,n)=>(0,s.mG)(we(e),void 0,void 0,(function*(){void 0===this.httpRandomDownloadInterval&&(this.httpRandomDownloadInterval=setInterval(this.downloadRandomSegmentOverHttp,this.settings.httpDownloadProbabilityInterval),this.settings.httpDownloadInitialTimeout>0&&this.settings.httpDownloadInitialTimeoutPerSegment>0&&(this.debugSegments("enable initial HTTP download timeout",this.settings.httpDownloadInitialTimeout,"per segment",this.settings.httpDownloadInitialTimeoutPerSegment),this.httpDownloadInitialTimeoutTimestamp=this.now(),setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment+100))),t.length>0&&(this.masterSwarmId=t[0].masterSwarmId),void 0!==this.masterSwarmId&&this.p2pManager.setStreamSwarmId(n,this.masterSwarmId),this.debug("load segments");let e=!1;console.log("LOAD SEGMENTS",this.segmentsQueue.length);for(const n of this.segmentsQueue)t.find((e=>e.id===n.id))||(this.debug("remove segment",n.url),this.httpManager.isDownloading(n)?(e=!0,this.httpManager.abort(n)):this.p2pManager.abort(n),this.emit(r.SegmentAbort,n));if(this.debug.enabled)for(const e of t)this.segmentsQueue.find((t=>t.id===e.id))||this.debug("add segment",e.url);if(this.segmentsQueue=t,void 0===this.masterSwarmId)return;let s=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);e=this.processSegmentsQueue(s)||e,(yield this.cleanSegmentsStorage())&&(s=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId),e=!0),e&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(s))})),e.getSegment=t=>(0,s.mG)(we(e),void 0,void 0,(function*(){return void 0===this.masterSwarmId?void 0:this.segmentsStorage.getSegment(t,this.masterSwarmId)})),e.getSettings=()=>e.settings,e.getDetails=()=>({peerId:e.p2pManager.getPeerId()}),e.getBandwidthEstimate=()=>e.bandwidthApproximator.getBandwidth(e.now()),e.destroy=()=>(0,s.mG)(we(e),void 0,void 0,(function*(){void 0!==this.httpRandomDownloadInterval&&(clearInterval(this.httpRandomDownloadInterval),this.httpRandomDownloadInterval=void 0),this.httpDownloadInitialTimeoutTimestamp=-1/0,this.segmentsQueue=[],this.httpManager.destroy(),this.p2pManager.destroy(),this.masterSwarmId=void 0,yield this.segmentsStorage.destroy()})),e.processInitialSegmentTimeout=()=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(void 0!==this.httpRandomDownloadInterval){if(void 0!==this.masterSwarmId){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}this.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment)}})),e.processSegmentsQueue=t=>{if(e.debugSegments("process segments queue. priority",e.segmentsQueue.length>0?e.segmentsQueue[0].priority:0),void 0===e.masterSwarmId||0===e.segmentsQueue.length)return!1;let n,r=!1,s=!0;if(e.httpDownloadInitialTimeoutTimestamp!==-1/0){let n;for(const r of e.segmentsQueue)if(!t.has(r.id)){n=r.priority;break}const r=e.now()-e.httpDownloadInitialTimeoutTimestamp;s=r>=e.settings.httpDownloadInitialTimeout||void 0!==n&&r>e.settings.httpDownloadInitialTimeoutPerSegment&&n<=0,s&&(e.debugSegments("cancel initial HTTP download timeout - timed out"),e.httpDownloadInitialTimeoutTimestamp=-1/0)}for(let o=0;o<e.segmentsQueue.length;o++){const i=e.segmentsQueue[o];if(!t.has(i.id))if(e.httpManager.isDownloading(i))e.httpManager.updatePriority(i);else{if(i.priority<=e.settings.requiredSegmentsPriority&&s&&!e.httpManager.isFailed(i)){if(e.httpManager.getActiveDownloadsCount()>=e.settings.simultaneousHttpDownloads)for(let t=e.segmentsQueue.length-1;t>o;t--){const n=e.segmentsQueue[t];if(e.httpManager.isDownloading(n)){e.debugSegments("cancel HTTP download",n.priority,n.url),e.httpManager.abort(n);break}}if(e.httpManager.getActiveDownloadsCount()<e.settings.simultaneousHttpDownloads){const t=e.p2pManager.abort(i);e.httpManager.download(i,t),e.debugSegments("HTTP download (priority)",i.priority,i.url),r=!0;continue}}if(!e.p2pManager.isDownloading(i))if(i.priority<=e.settings.requiredSegmentsPriority){if(n=n||e.p2pManager.getOverallSegmentsMap(),n.get(i.id)!==k.Loaded)continue;if(e.p2pManager.getActiveDownloadsCount()>=e.settings.simultaneousP2PDownloads)for(let t=e.segmentsQueue.length-1;t>o;t--){const n=e.segmentsQueue[t];if(e.p2pManager.isDownloading(n)){e.debugSegments("cancel P2P download",n.priority,n.url),e.p2pManager.abort(n);break}}if(e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&e.p2pManager.download(i)){e.debugSegments("P2P download (priority)",i.priority,i.url);continue}}else e.p2pManager.getActiveDownloadsCount()<e.settings.simultaneousP2PDownloads&&i.priority<=e.settings.p2pDownloadMaxPriority&&e.p2pManager.download(i)&&e.debugSegments("P2P download",i.priority,i.url)}}return r},e.downloadRandomSegmentOverHttp=()=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(void 0===this.masterSwarmId||void 0===this.httpRandomDownloadInterval||this.httpDownloadInitialTimeoutTimestamp!==-1/0||this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads||this.settings.httpDownloadProbabilitySkipIfNoPeers&&0===this.p2pManager.getPeers().size||this.settings.consumeOnly)return;const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId),t=this.p2pManager.getOverallSegmentsMap(),n=this.segmentsQueue.filter((n=>!this.p2pManager.isDownloading(n)&&!this.httpManager.isDownloading(n)&&!t.has(n.id)&&!this.httpManager.isFailed(n)&&n.priority<=this.settings.httpDownloadMaxPriority&&!e.has(n.id)));if(0===n.length)return;if(Math.random()>this.settings.httpDownloadProbability*n.length)return;const r=n[Math.floor(Math.random()*n.length)];this.debugSegments("HTTP download (random)",r.priority,r.url),this.httpManager.download(r),this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})),e.onSegmentStartLoad=(t,n)=>{e.emit(r.SegmentStartLoad,t,n)},e.onPieceBytesDownloaded=(t,n,s,o)=>{e.bandwidthApproximator.addBytes(s,e.now()),e.emit(r.PieceBytesDownloaded,t,n,s,o)},e.onPieceBytesUploaded=(t,n,s,o)=>{e.emit(r.PieceBytesUploaded,t,n,s,o)},e.onSegmentLoaded=(t,n,o)=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(this.debugSegments("segment loaded",t.id,t.url),void 0===this.masterSwarmId)return;t.data=n,t.downloadBandwidth=this.bandwidthApproximator.getBandwidth(this.now()),yield this.segmentsStorage.storeSegment(t),this.emit(r.SegmentLoaded,t,o);const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e),this.settings.consumeOnly||this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})),e.onSegmentError=(t,n,o)=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(this.debugSegments("segment error",t.id,t.url,o,n),this.emit(r.SegmentError,t,n,o),void 0!==this.masterSwarmId){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}})),e.onSegmentSize=(t,n)=>(0,s.mG)(we(e),void 0,void 0,(function*(){this.debugSegments("segment size",t.id,n),this.emit(r.SegmentSize,t,n)})),e.getStreamSwarmId=e=>void 0===e.streamId?e.masterSwarmId:`${e.masterSwarmId}+${e.streamId}`,e.createSegmentsMap=t=>{const n={},r=(t,r)=>{const s=e.getStreamSwarmId(t),o=t.sequence;let i=n[s];void 0===i&&(i=["",[]],n[s]=i);const a=i[1];i[0]+=0===a.length?o:`|${o}`,a.push(r)};for(const e of t.values())r(e.segment,k.Loaded);for(const t of e.httpManager.getActiveDownloads().values())r(t.segment,k.LoadingByHttp);return n},e.onPeerConnect=t=>(0,s.mG)(we(e),void 0,void 0,(function*(){this.emit(r.PeerConnect,t),this.settings.consumeOnly||void 0===this.masterSwarmId||this.p2pManager.sendSegmentsMap(t.id,this.createSegmentsMap(yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId)))})),e.onPeerClose=t=>{e.emit(r.PeerClose,t)},e.onTrackerUpdate=t=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(this.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==t.incomplete&&t.incomplete<=1&&(this.debugSegments("cancel initial HTTP download timeout - no peers"),this.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==this.masterSwarmId)){const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}})),e.cleanSegmentsStorage=()=>(0,s.mG)(we(e),void 0,void 0,(function*(){return void 0!==this.masterSwarmId&&this.segmentsStorage.clean(this.masterSwarmId,(e=>void 0!==this.segmentsQueue.find((t=>t.id===e))))})),e.now=()=>performance.now(),e.settings=Object.assign(Object.assign({},ve),t);const{bufferedSegmentsCount:n}=t;return"number"==typeof n&&(void 0===t.p2pDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n),void 0===t.httpDownloadMaxPriority&&(e.settings.p2pDownloadMaxPriority=n)),e.segmentsStorage=void 0===e.settings.segmentsStorage?new me(e.settings):e.settings.segmentsStorage,e.debug("loader settings",e.settings),e.httpManager=e.createHttpManager(),e.httpManager.on("segment-start-load",(t=>e.onSegmentStartLoad("http",t))),e.httpManager.on("segment-loaded",e.onSegmentLoaded),e.httpManager.on("segment-error",e.onSegmentError),e.httpManager.on("segment-size",e.onSegmentSize),e.httpManager.on("bytes-downloaded",((t,n)=>{e.onPieceBytesDownloaded("http",t,n)})),e.p2pManager=e.createP2PManager(),e.p2pManager.on("segment-start-load",(t=>e.onSegmentStartLoad("p2p",t))),e.p2pManager.on("segment-loaded",e.onSegmentLoaded),e.p2pManager.on("segment-error",e.onSegmentError),e.p2pManager.on("segment-size",e.onSegmentSize),e.p2pManager.on("peer-data-updated",(()=>(0,s.mG)(we(e),void 0,void 0,(function*(){if(void 0===this.masterSwarmId)return;const e=yield this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))})))),e.p2pManager.on("bytes-downloaded",((t,n,r)=>e.onPieceBytesDownloaded("p2p",t,n,r))),e.p2pManager.on("bytes-uploaded",((t,n,r)=>e.onPieceBytesUploaded("p2p",t,n,r))),e.p2pManager.on("peer-connected",e.onPeerConnect),e.p2pManager.on("peer-closed",e.onPeerClose),e.p2pManager.on("tracker-update",e.onTrackerUpdate),e}return t=l,n&&pe(t.prototype,n),o&&pe(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t}(a.EventEmitter);Pe.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},9502:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Engine:()=>T,SegmentManager:()=>p,initClapprPlayer:()=>C,initFlowplayerHlsJsPlayer:()=>D,initHlsJsPlayer:()=>q,initJwPlayer:()=>A,initMediaElementJsPlayer:()=>j,initVideoJsContribHlsJsPlayer:()=>k,initVideoJsHlsJsPlugin:()=>E,version:()=>O});var r=n(649),s=n(5101),o=n(3819),i=n(51);function a(e){return e.rangeEnd&&void 0!==e.rangeStart?{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart}:void 0}function l(e,t){return void 0===e?void 0===t:void 0!==t&&e.length===t.length&&e.offset===t.offset}function d(e){if(void 0===e)return;const t=e.offset+e.length-1;return`bytes=${e.offset}-${t}`}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&g(e.prototype,t),n&&g(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}const m={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};let p=function(){function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};u(this,e),this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.fetch=function(){return fetch.apply(void 0,arguments)},this.playQueue=[],this.onSegmentLoaded=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onSuccess(e.data.slice(0),e.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(e,t)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError(t),this.segmentRequest=null)},this.onSegmentAbort=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&d(this.segmentRequest.segmentByteRange)===e.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},m),n.segments),this.loader=t,this.loader.on(o.zW.SegmentLoaded,this.onSegmentLoaded),this.loader.on(o.zW.SegmentError,this.onSegmentError),this.loader.on(o.zW.SegmentAbort,this.onSegmentAbort),n.loader&&n.loader.localTransport&&(this.fetch=n.loader.localTransport)}return c(e,[{key:"getSettings",value:function(){return this.settings}},{key:"processPlaylist",value:function(e,t,n){const r=new i._b;r.push(t),r.end();const s=new f(e,n,r.manifest);if(s.manifest.playlists){this.masterPlaylist=s;for(const[e,t]of this.variantPlaylists){const{streamSwarmId:n,found:r,index:s}=this.getStreamSwarmId(t.requestUrl);r?(t.streamSwarmId=n,t.streamId="V"+s.toString()):this.variantPlaylists.delete(e)}}else{const{streamSwarmId:t,found:n,index:r}=this.getStreamSwarmId(e);(n||null===this.masterPlaylist)&&(s.streamSwarmId=t,s.streamId=null===this.masterPlaylist?void 0:"V"+r.toString(),this.variantPlaylists.set(e,s),this.updateSegments())}}},{key:"loadPlaylist",value:function(e){return(0,r.mG)(this,void 0,void 0,(function*(){const t=this.settings.assetsStorage;let n;if(void 0!==t){let r;r=this.getMasterSwarmId(),void 0===r&&(r=e.split("?")[0]);const s=yield t.getAsset(e,void 0,r);if(void 0!==s)n={responseURL:s.responseUri,response:s.data};else{const s=yield this.loadContent(e);n={responseURL:s.url,response:yield s.text()},t.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e,masterSwarmId:r,requestUri:e,responseUri:n.responseURL,data:yield n.response})}}else{const t=yield this.loadContent(e);n={responseURL:t.url,response:yield t.text()}}return this.processPlaylist(e,n.response,n.responseURL),n}))}},{key:"loadSegment",value:function(e,t){var n;return(0,r.mG)(this,void 0,void 0,(function*(){const r=this.getSegmentLocation(e,t),s=d(t);if(!r){let t;const r=this.settings.assetsStorage;if(void 0!==r){let o,i=null===(n=this.masterPlaylist)||void 0===n?void 0:n.requestUrl;if(o=this.getMasterSwarmId(),void 0===o&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(o=e.value.requestUrl.split("?")[0])}if(void 0===i&&1===this.variantPlaylists.size){const e=this.variantPlaylists.values().next();e.done||(i=e.value.requestUrl)}if(void 0!==o&&void 0!==i){const n=yield r.getAsset(e,s,o);if(void 0!==n)t=n.data;else{const n=yield this.loadContent(e,s);t=yield n.arrayBuffer(),r.storeAsset({masterManifestUri:i,masterSwarmId:o,requestUri:e,requestRange:s,responseUri:n.url,data:t})}}}if(void 0===t){const n=yield this.loadContent(e,s);t=yield n.arrayBuffer()}return{content:t,downloadBandwidth:0}}const o=(r.playlist.manifest.mediaSequence?r.playlist.manifest.mediaSequence:0)+r.segmentIndex;if(this.playQueue.length>0){this.playQueue[this.playQueue.length-1].segmentSequence!==o-1&&(this.playQueue=[])}this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const i=new Promise(((n,s)=>{this.segmentRequest=new h(e,t,o,r.playlist.requestUrl,((e,t)=>n({content:e,downloadBandwidth:t})),(e=>s(e)))}));return this.playQueue.push({segmentUrl:e,segmentByteRange:t,segmentSequence:o}),this.loadSegments(r.playlist,r.segmentIndex,!0),i}))}},{key:"setPlayingSegment",value:function(e,t,n,r){const s=this.playQueue.findIndex((n=>n.segmentUrl===e&&l(n.segmentByteRange,t)));s>=0&&(this.playQueue=this.playQueue.slice(s),this.playQueue[0].playPosition={start:n,duration:r},this.updateSegments())}},{key:"setPlayingSegmentByCurrentTime",value:function(e){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const t=this.playQueue[0].playPosition;t.start+t.duration-e<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}},{key:"abortSegment",value:function(e,t){this.segmentRequest&&this.segmentRequest.segmentUrl===e&&l(this.segmentRequest.segmentByteRange,t)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}},{key:"destroy",value:function(){return(0,r.mG)(this,void 0,void 0,(function*(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&(yield this.settings.assetsStorage.destroy()),yield this.loader.destroy()}))}},{key:"updateSegments",value:function(){if(!this.segmentRequest)return;const e=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);e&&this.loadSegments(e.playlist,e.segmentIndex,!1)}},{key:"getSegmentLocation",value:function(e,t){for(const n of this.variantPlaylists.values()){const r=n.getSegmentIndex(e,t);if(r>=0)return{playlist:n,segmentIndex:r}}}},{key:"loadSegments",value:function(e,t,n){var s;return(0,r.mG)(this,void 0,void 0,(function*(){const r=[],o=e.manifest.segments,i=null!==(s=e.manifest.mediaSequence)&&void 0!==s?s:0;let a=null,l=Math.max(0,this.playQueue.length-1);const u=this.getMasterSwarmId();for(let s=t;s<o.length&&r.length<this.settings.forwardSegmentCount;++s){const t=e.manifest.segments[s],o=e.getSegmentAbsoluteUrl(t.uri),g=t.byterange,c=this.getSegmentId(e,i+s);r.push({id:c,url:o,masterSwarmId:void 0!==u?u:e.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e.requestUrl,streamId:e.streamId,sequence:(i+s).toString(),range:d(g),priority:l++}),n&&!a&&(a=c)}if(this.loader.load(r,e.streamSwarmId),a){const e=yield this.loader.getSegment(a);e&&this.onSegmentLoaded(e)}}))}},{key:"getSegmentId",value:function(e,t){return`${e.streamSwarmId}+${t}`}},{key:"getMasterSwarmId",value:function(){const e=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==e?e:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}},{key:"getStreamSwarmId",value:function(e){const t=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&t)for(let n=0;n<this.masterPlaylist.manifest.playlists.length;++n){if(new URL(this.masterPlaylist.manifest.playlists[n].uri,this.masterPlaylist.responseUrl).toString()===e)return{streamSwarmId:`${t}+V${n}`,found:!0,index:n}}return{streamSwarmId:null!=t?t:e.split("?")[0],found:!1,index:-1}}},{key:"loadContent",value:function(e,t){return(0,r.mG)(this,void 0,void 0,(function*(){const n=new Headers;t&&n.append("Range",t);const r=this.fetch(e,{headers:n});return r.catch((e=>{})),r}))}}]),e}(),f=function(){function e(t,n,r){u(this,e),this.requestUrl=t,this.responseUrl=n,this.manifest=r,this.streamSwarmId=""}return c(e,[{key:"getSegmentIndex",value:function(e,t){for(let n=0;n<this.manifest.segments.length;++n){const r=this.manifest.segments[n];if(e===this.getSegmentAbsoluteUrl(r.uri)&&l(r.byterange,t))return n}return-1}},{key:"getSegmentAbsoluteUrl",value:function(e){return new URL(e,this.responseUrl).toString()}}]),e}(),h=c((function e(t,n,r,s,o,i){u(this,e),this.segmentUrl=t,this.segmentByteRange=n,this.segmentSequence=r,this.playlistRequestUrl=s,this.onSuccess=o,this.onError=i}));function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}let S=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isLoaded=!1,this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.segmentManager=t}var t,n,s;return t=e,s=[{key:"updateStatsToStartLoading",value:function(e){const t=performance.now();e.loading.start=t,e.loading.first=t}}],(n=[{key:"load",value:function(t,n,s){return(0,r.mG)(this,void 0,void 0,(function*(){if(e.updateStatsToStartLoading(this.stats),t.type)try{const e=yield this.segmentManager.loadPlaylist(t.url);this.isLoaded=!0,this.successPlaylist(e,t,s)}catch(e){this.error(e,t,s)}else if(t.frag){const{loader:n}=this.segmentManager,r=a(t),i=e=>e.url===t.url&&e.range===d(r);let l=setInterval((()=>{e.updateStatsToStartLoading(this.stats)}),200);const u=(e,t)=>{i(e)&&(this.stats.total=t)};n.on(o.zW.SegmentSize,u);const g=(e,t,n)=>{i(t)&&(this.stats.loaded+=n)},c=(t,r)=>{l&&"http"===t&&i(r)&&(clearInterval(l),l=void 0,e.updateStatsToStartLoading(this.stats),n.on(o.zW.PieceBytesDownloaded,g))};n.on(o.zW.SegmentStartLoad,c);try{const e=yield this.segmentManager.loadSegment(t.url,r),{content:i}=e;i&&(this.isLoaded=!0,setTimeout((()=>this.successSegment(i,t,s)),0))}catch(e){setTimeout((()=>this.error(e,t,s)),0)}finally{clearInterval(l),n.off(o.zW.SegmentStartLoad,c),n.off(o.zW.SegmentSize,u),n.off(o.zW.PieceBytesDownloaded,g)}}else console.warn("Unknown load request",t)}))}},{key:"abort",value:function(e,t){if(this.isLoaded)return;this.segmentManager.abortSegment(e.url,a(e)),this.stats.aborted=!0;const n=null==t?void 0:t.onAbort;n&&n(this.stats,e,void 0)}},{key:"successPlaylist",value:function(e,t,n){const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.response.length,this.stats.total=e.response.length,n.onSuccess({url:e.responseURL,data:e.response},this.stats,t,void 0)}},{key:"successSegment",value:function(e,t,n){const r=performance.now();this.stats.loading.end=r,this.stats.loaded=e.byteLength,this.stats.total=e.byteLength,n.onProgress&&n.onProgress(this.stats,t,e,void 0),n.onSuccess({url:t.url,data:e},this.stats,t,void 0)}},{key:"error",value:function(e,t,n){n.onError(e,t,void 0)}}])&&y(t.prototype,n),s&&y(t,s),Object.defineProperty(t,"prototype",{writable:!1}),e}();function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function P(e,t){return P=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},P(e,t)}function R(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I(e);if(t){var s=I(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return M(this,n)}}function M(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function I(e){return I=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},I(e)}let T=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&P(e,t)}(n,e);var t=R(n);function n(){var e;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return w(this,n),(e=t.call(this)).loader=new o.ou(r.loader),e.segmentManager=new p(e.loader,r),Object.keys(o.zW).map((e=>o.zW[e])).forEach((t=>e.loader.on(t,(function(){for(var n,r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return(n=e).emit.apply(n,[t].concat(s))})))),e}return v(n,[{key:"createLoaderClass",value:function(){var e;const t=this;return(e=v((function e(){w(this,e),this.load=(e,t,n)=>(0,r.mG)(this,void 0,void 0,(function*(){this.context=e,this.callbacks=n,this.impl.load(e,t,n)})),this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context)},this.getResponseHeader=()=>{},this.impl=new S(t.segmentManager),this.stats=this.impl.stats}))).getEngine=()=>t,e}},{key:"destroy",value:function(){return(0,r.mG)(this,void 0,void 0,(function*(){yield this.segmentManager.destroy()}))}},{key:"getSettings",value:function(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}},{key:"getDetails",value:function(){return{loader:this.loader.getDetails()}}},{key:"setPlayingSegment",value:function(e,t,n,r){this.segmentManager.setPlayingSegment(e,t,n,r)}},{key:"setPlayingSegmentByCurrentTime",value:function(e){this.segmentManager.setPlayingSegmentByCurrentTime(e)}}],[{key:"isSupported",value:function(){return o.ou.isSupported()}}]),n}(s.EventEmitter);const O="0.6.2";function q(e){e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&B(e,e.config.loader.getEngine())}function C(e){e.on("play",(()=>{const t=e.core.getCurrentPlayback();t._hls&&!t._hls._p2pm_linitialized&&(t._hls._p2pm_linitialized=!0,q(e.core.getCurrentPlayback()._hls))}))}function D(e){e.on("ready",(()=>{var t;return q(null!==(t=e.engine.hlsjs)&&void 0!==t?t:e.engine.hls)}))}function k(e){e.ready((()=>{const t=e.tech_.options_;t&&t.hlsjsConfig&&t.hlsjsConfig.loader&&"function"==typeof t.hlsjsConfig.loader.getEngine&&B(e.tech_,t.hlsjsConfig.loader.getEngine())}))}function E(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&B(t,t.config.loader.getEngine())}))}function j(e){e.addEventListener("hlsFragChanged",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine){const e=n.config.loader.getEngine();if(t.data&&t.data.length>1){const n=t.data[1].frag,r=2!==n.byteRange.length?void 0:{offset:n.byteRange[0],length:n.byteRange[1]-n.byteRange[0]};e.setPlayingSegment(n.url,r,n.start,n.duration)}}})),e.addEventListener("hlsDestroying",(()=>(0,r.mG)(this,void 0,void 0,(function*(){const t=e.hlsPlayer;if(t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine){const e=t.config.loader.getEngine();yield e.destroy()}})))),e.addEventListener("hlsError",(t=>{const n=e.hlsPlayer;if(n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&void 0!==t.data&&"bufferStalledError"===t.data.details){n.config.loader.getEngine().setPlayingSegmentByCurrentTime(n.media.currentTime)}}))}function A(e,t){const n=setInterval((()=>{e.hls&&e.hls.config&&(clearInterval(n),Object.assign(e.hls.config,t),q(e.hls))}),200)}function B(e,t){e.on("hlsFragChanged",((e,n)=>{const r=n.frag,s=2!==r.byteRange.length?void 0:{offset:r.byteRange[0],length:r.byteRange[1]-r.byteRange[0]};t.setPlayingSegment(r.url,s,r.start,r.duration)})),e.on("hlsDestroying",(()=>(0,r.mG)(this,void 0,void 0,(function*(){yield t.destroy()})))),e.on("hlsError",((n,r)=>{if("bufferStalledError"===r.details){const n=void 0===e.media?e.el_:e.media;n&&t.setPlayingSegmentByCurrentTime(n.currentTime)}}))}},9354:()=>{},3762:()=>{},8333:()=>{},59:()=>{},2361:()=>{},4616:()=>{},3719:()=>{}}]);
//# sourceMappingURL=795.chunk.js.map